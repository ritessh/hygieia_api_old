<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DashboardServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.capitalone.dashboard:api</a> &gt; <a href="index.source.html" class="el_package">com.capitalone.dashboard.service</a> &gt; <span class="el_source">DashboardServiceImpl.java</span></div><h1>DashboardServiceImpl.java</h1><pre class="source lang-java linenums">package com.capitalone.dashboard.service;

import com.capitalone.dashboard.auth.AuthenticationUtil;
import com.capitalone.dashboard.auth.exceptions.UserNotFoundException;
import com.capitalone.dashboard.misc.HygieiaException;
import com.capitalone.dashboard.model.AuthType;
import com.capitalone.dashboard.model.BaseModel;
import com.capitalone.dashboard.model.Cmdb;
import com.capitalone.dashboard.model.Collector;
import com.capitalone.dashboard.model.CollectorItem;
import com.capitalone.dashboard.model.CollectorType;
import com.capitalone.dashboard.model.Component;
import com.capitalone.dashboard.model.Dashboard;
import com.capitalone.dashboard.model.DashboardType;
import com.capitalone.dashboard.model.DataResponse;
import com.capitalone.dashboard.model.Owner;
import com.capitalone.dashboard.model.ScoreDisplayType;
import com.capitalone.dashboard.model.Widget;
import com.capitalone.dashboard.repository.CollectorItemRepository;
import com.capitalone.dashboard.repository.CollectorRepository;
import com.capitalone.dashboard.repository.ComponentRepository;
import com.capitalone.dashboard.repository.CustomRepositoryQuery;
import com.capitalone.dashboard.repository.DashboardRepository;
import com.capitalone.dashboard.repository.PipelineRepository;
import com.capitalone.dashboard.repository.ServiceRepository;
import com.capitalone.dashboard.repository.UserInfoRepository;
import com.capitalone.dashboard.settings.ApiSettings;
import com.capitalone.dashboard.util.UnsafeDeleteException;
import com.google.common.base.Predicate;
import com.google.common.collect.Iterables;
import com.google.common.collect.Lists;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.bson.types.ObjectId;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import java.util.EnumSet;
import java.util.List;
import java.util.Map;
import java.util.ArrayList;
import java.util.Set;
import java.util.HashSet;
import java.util.HashMap;
import java.util.Objects;

import java.util.stream.Collectors;

@Service
public class DashboardServiceImpl implements DashboardService {

<span class="fc" id="L57">    private static final Log LOG = LogFactory.getLog(DashboardServiceImpl.class);</span>
    private final DashboardRepository dashboardRepository;
    private final ComponentRepository componentRepository;
    private final CollectorRepository collectorRepository;
    private final CollectorItemRepository collectorItemRepository;
    private final CustomRepositoryQuery customRepositoryQuery;
    @SuppressWarnings(&quot;unused&quot;)
    private final PipelineRepository pipelineRepository; //NOPMD
    private final ServiceRepository serviceRepository;
    private final UserInfoRepository userInfoRepository;
    private final UserInfoService userInfoService;
    private final ScoreDashboardService scoreDashboardService;
    private final CmdbService cmdbService;
<span class="fc" id="L70">    private final String UNDEFINED = &quot;undefined&quot;;</span>
<span class="fc" id="L71">    public final static EnumSet&lt;CollectorType&gt; QualityWidget = EnumSet.of(CollectorType.Test , CollectorType.StaticSecurityScan, CollectorType.CodeQuality, CollectorType.LibraryPolicy);</span>
    public static final String BUILD = &quot;build&quot;;
    public static final String FEATURE = &quot;feature&quot;;
    public static final String DEPLOY = &quot;deploy&quot;;
    public static final String REPO = &quot;repo&quot;;
    public static final String PERFORMANCE = &quot;performanceanalysis&quot;;
    public static final String CLOUD = &quot;cloud&quot;;
    public static final String CHATOPS = &quot;chatops&quot;;
    public static final String TEST = &quot;test&quot;;
    public static final String CODEANALYSIS = &quot;codeanalysis&quot;;
    public static final String INFRA_SCAN = &quot;infrascan&quot;;

    @Autowired
    private ApiSettings settings;

    @Autowired
    public DashboardServiceImpl(DashboardRepository dashboardRepository,
                                ComponentRepository componentRepository,
                                CollectorRepository collectorRepository,
                                CollectorItemRepository collectorItemRepository,
                                CustomRepositoryQuery customRepositoryQuery,
                                ServiceRepository serviceRepository,
                                PipelineRepository pipelineRepository,
                                UserInfoRepository userInfoRepository,
                                UserInfoService userInfoService,
                                CmdbService cmdbService,
                                ScoreDashboardService scoreDashboardService,
<span class="fc" id="L98">                                ApiSettings settings) {</span>
<span class="fc" id="L99">        this.dashboardRepository = dashboardRepository;</span>
<span class="fc" id="L100">        this.componentRepository = componentRepository;</span>
<span class="fc" id="L101">        this.collectorRepository = collectorRepository;</span>
<span class="fc" id="L102">        this.collectorItemRepository = collectorItemRepository;</span>
<span class="fc" id="L103">        this.customRepositoryQuery = customRepositoryQuery;</span>
<span class="fc" id="L104">        this.serviceRepository = serviceRepository;</span>
<span class="fc" id="L105">        this.pipelineRepository = pipelineRepository;   //TODO - Review if we need this param, seems it is never used according to PMD</span>
<span class="fc" id="L106">        this.userInfoRepository = userInfoRepository;</span>
<span class="fc" id="L107">        this.userInfoService = userInfoService;</span>
<span class="fc" id="L108">        this.cmdbService = cmdbService;</span>
<span class="fc" id="L109">        this.scoreDashboardService = scoreDashboardService;</span>
<span class="fc" id="L110">        this.settings = settings;</span>
<span class="fc" id="L111">    }</span>

    @Override
    public Iterable&lt;Dashboard&gt; all() {
<span class="fc" id="L115">        Iterable&lt;Dashboard&gt; dashboards = dashboardRepository.findAll(new Sort(Sort.Direction.ASC, &quot;title&quot;));</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        for(Dashboard dashboard: dashboards){</span>
<span class="nc" id="L117">            String appName = dashboard.getConfigurationItemBusServName();</span>
<span class="nc" id="L118">            String compName = dashboard.getConfigurationItemBusAppName();</span>

<span class="nc" id="L120">            setAppAndComponentNameToDashboard(dashboard, appName, compName);</span>
<span class="nc" id="L121">        }</span>
<span class="fc" id="L122">        return dashboards;</span>
    }

    @Override
    public Iterable&lt;Dashboard&gt; allTemplate(String template){
<span class="nc" id="L127">        Iterable&lt;Dashboard&gt; templateDashboards = dashboardRepository.findByTemplate(template);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        for(Dashboard dashboard: templateDashboards) {</span>
<span class="nc" id="L129">            String appName = dashboard.getConfigurationItemBusServName();</span>
<span class="nc" id="L130">            String compName = dashboard.getConfigurationItemBusAppName();</span>

<span class="nc" id="L132">            setAppAndComponentNameToDashboard(dashboard, appName, compName);</span>
<span class="nc" id="L133">        }</span>
<span class="nc" id="L134">        return templateDashboards;</span>
    }


    @Override
    public Dashboard get(ObjectId id) {
<span class="fc" id="L140">        Dashboard dashboard = dashboardRepository.findOne(id);</span>
<span class="fc" id="L141">        String appName = dashboard.getConfigurationItemBusServName();</span>
<span class="fc" id="L142">        String compName = dashboard.getConfigurationItemBusAppName();</span>

<span class="fc" id="L144">        setAppAndComponentNameToDashboard(dashboard, appName, compName);</span>

<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (!dashboard.getApplication().getComponents().isEmpty()) {</span>
            // Add transient Collector instance to each CollectorItem
<span class="fc" id="L148">            Map&lt;CollectorType, List&lt;CollectorItem&gt;&gt; itemMap = dashboard.getApplication().getComponents().get(0).getCollectorItems();</span>

<span class="fc" id="L150">            Iterable&lt;Collector&gt; collectors = collectorsFromItems(itemMap);</span>

<span class="fc bfc" id="L152" title="All 2 branches covered.">            for (List&lt;CollectorItem&gt; collectorItems : itemMap.values()) {</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">                for (CollectorItem collectorItem : collectorItems) {</span>
<span class="fc" id="L154">                    collectorItem.setCollector(getCollector(collectorItem.getCollectorId(), collectors));</span>
<span class="fc" id="L155">                }</span>
<span class="fc" id="L156">            }</span>
        }

<span class="fc" id="L159">        return dashboard;</span>
    }

    /**
     * Get all the dashboards that have the collector items
     *
     * @param collectorItems collector items
     * @param collectorType  type of the collector
     * @return a list of dashboards
     */
    @Override
    public List&lt;Dashboard&gt; getDashboardsByCollectorItems(Set&lt;CollectorItem&gt; collectorItems, CollectorType collectorType) {
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (org.apache.commons.collections4.CollectionUtils.isEmpty(collectorItems)) {</span>
<span class="nc" id="L172">            return new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L174">        List&lt;ObjectId&gt; collectorItemIds = collectorItems.stream().map(BaseModel::getId).collect(Collectors.toList());</span>
        // Find the components that have these collector items
<span class="nc" id="L176">        List&lt;com.capitalone.dashboard.model.Component&gt; components = componentRepository.findByCollectorTypeAndItemIdIn(collectorType, collectorItemIds);</span>
<span class="nc" id="L177">        List&lt;ObjectId&gt; componentIds = components.stream().map(BaseModel::getId).collect(Collectors.toList());</span>
<span class="nc" id="L178">        return dashboardRepository.findByApplicationComponentIdsIn(componentIds);</span>
    }

    private Dashboard create(Dashboard dashboard, boolean isUpdate) throws HygieiaException {
<span class="fc" id="L182">        Iterable&lt;Component&gt; components = null;</span>

<span class="fc bfc" id="L184" title="All 2 branches covered.">        if(!isUpdate) {</span>
<span class="fc" id="L185">            dashboard.setCreatedAt(System.currentTimeMillis());</span>
<span class="fc" id="L186">            components = componentRepository.save(dashboard.getApplication().getComponents());</span>
        }
<span class="fc" id="L188">        dashboard.setUpdatedAt(System.currentTimeMillis());</span>

        try {
<span class="fc" id="L191">            duplicateDashboardErrorCheck(dashboard);</span>
<span class="fc" id="L192">            Dashboard savedDashboard = dashboardRepository.save(dashboard);</span>
            CollectorItem scoreCollectorItem;
<span class="fc bfc" id="L194" title="All 2 branches covered.">            if (isUpdate) {</span>
<span class="fc" id="L195">                scoreCollectorItem = this.scoreDashboardService.editScoreForDashboard(savedDashboard);</span>
            } else {
<span class="fc" id="L197">                scoreCollectorItem = this.scoreDashboardService.addScoreForDashboardIfScoreEnabled(savedDashboard);</span>
            }
<span class="fc" id="L199">            return savedDashboard;</span>
<span class="fc" id="L200">        }  catch (Exception e) {</span>
            //Exclude deleting of components if this is an update request
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">            if(!isUpdate) {</span>
<span class="fc" id="L203">                componentRepository.delete(components);</span>
            }

<span class="pc bpc" id="L206" title="1 of 2 branches missed.">            if(e instanceof HygieiaException){</span>
<span class="nc" id="L207">                throw e;</span>
            }else{
<span class="fc" id="L209">                throw new HygieiaException(&quot;Failed creating dashboard.&quot;, HygieiaException.ERROR_INSERTING_DATA);</span>
            }
        }
    }

    @Override
    public Dashboard create(Dashboard dashboard) throws HygieiaException {
<span class="fc" id="L216">        return create(dashboard, false);</span>
    }
    @Override
    public Dashboard update(Dashboard dashboard) throws HygieiaException {
<span class="fc" id="L220">        return create(dashboard, true);</span>
    }

    @Override
    public void delete(ObjectId id) {
<span class="fc" id="L225">        Dashboard dashboard = dashboardRepository.findOne(id);</span>

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (!isSafeDelete(dashboard)) {</span>
<span class="nc" id="L228">            throw new UnsafeDeleteException(&quot;Cannot delete team dashboard &quot; + dashboard.getTitle() + &quot; as it is referenced by program dashboards.&quot;);</span>
        }


        // Remove this Dashboard's services and service dependencies
<span class="fc" id="L233">        serviceRepository.delete(serviceRepository.findByDashboardId(id));</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">        for (com.capitalone.dashboard.model.Service service : serviceRepository.findByDependedBy(id)) { //NOPMD - using fully qualified or we pickup an incorrect spring class</span>
<span class="fc" id="L235">            service.getDependedBy().remove(id);</span>
<span class="fc" id="L236">            serviceRepository.save(service);</span>
<span class="fc" id="L237">        }</span>

        /**
         * Delete Dashboard. Then delete component. Then disable collector items if needed
         */
<span class="fc" id="L242">        dashboardRepository.delete(dashboard);</span>
<span class="fc" id="L243">        componentRepository.delete(dashboard.getApplication().getComponents());</span>
<span class="fc" id="L244">        handleCollectorItems(dashboard.getApplication().getComponents());</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (dashboard.isScoreEnabled()) {</span>
<span class="nc" id="L246">            this.scoreDashboardService.disableScoreForDashboard(dashboard);</span>
        }

<span class="fc" id="L249">    }</span>

    /**
     * For the dashboard, get all the components and get all the collector items for the components.
     * If a collector item is NOT associated with any Component, disable it.
     * @param components
     */
    private void handleCollectorItems(List&lt;Component&gt; components) {
<span class="fc bfc" id="L257" title="All 2 branches covered.">        for (Component component : components) {</span>
<span class="fc" id="L258">            Map&lt;CollectorType, List&lt;CollectorItem&gt;&gt; itemMap = component.getCollectorItems();</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">            for (CollectorType type : itemMap.keySet()) {</span>
<span class="fc" id="L260">                List&lt;CollectorItem&gt; items = itemMap.get(type);</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">                for (CollectorItem i : items) {</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">                    if (CollectionUtils.isEmpty(customRepositoryQuery.findComponents(i.getCollectorId(),type,i))) {</span>
<span class="fc" id="L263">                        i.setEnabled(false);</span>
<span class="fc" id="L264">                        i.setLastUpdated(System.currentTimeMillis());</span>
<span class="fc" id="L265">                        collectorItemRepository.save(i);</span>
                    }
<span class="fc" id="L267">                }</span>
<span class="fc" id="L268">            }</span>
<span class="fc" id="L269">        }</span>
<span class="fc" id="L270">    }</span>

    private boolean isSafeDelete(Dashboard dashboard) {
<span class="pc bpc" id="L273" title="3 of 6 branches missed.">        return !(dashboard.getType() == null || dashboard.getType().equals(DashboardType.Team)) || isSafeTeamDashboardDelete(dashboard);</span>
    }

    private boolean isSafeTeamDashboardDelete(Dashboard dashboard) {
<span class="fc" id="L277">        boolean isSafe = false;</span>
<span class="fc" id="L278">        List&lt;Collector&gt; productCollectors = collectorRepository.findByCollectorType(CollectorType.Product);</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">        if (productCollectors.isEmpty()) {</span>
<span class="fc" id="L280">            return true;</span>
        }

<span class="nc" id="L283">        Collector productCollector = productCollectors.get(0);</span>

<span class="nc" id="L285">        CollectorItem teamDashboardCollectorItem = collectorItemRepository.findTeamDashboardCollectorItemsByCollectorIdAndDashboardId(productCollector.getId(), dashboard.getId().toString());</span>

        //// TODO: 1/21/16 Is this safe? What if we add a new team dashbaord and quickly add it to a product and then delete it?
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (teamDashboardCollectorItem == null) {</span>
<span class="nc" id="L289">            return true;</span>
        }

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (dashboardRepository.findProductDashboardsByTeamDashboardCollectorItemId(teamDashboardCollectorItem.getId().toString()).isEmpty()) {</span>
<span class="nc" id="L293">            isSafe = true;</span>
        }
<span class="nc" id="L295">        return isSafe;</span>
    }

    @Override
    public Component associateCollectorToComponent(ObjectId componentId, List&lt;ObjectId&gt; collectorItemIds, boolean cleanupQuality) {
<span class="pc bpc" id="L300" title="2 of 4 branches missed.">        if (componentId == null || collectorItemIds == null) {</span>
            // Not all widgets gather data from collectors
<span class="nc" id="L302">            return null;</span>
        }
<span class="fc" id="L304">        com.capitalone.dashboard.model.Component component = componentRepository.findOne(componentId); //NOPMD - using fully qualified name for clarity</span>
<span class="fc" id="L305">        associateCollectorItemsToComponent(collectorItemIds, true, component, cleanupQuality);</span>
<span class="fc" id="L306">        return component;</span>
    }

    @Override
    public Component associateCollectorToComponent(ObjectId componentId, List&lt;ObjectId&gt; collectorItemIds,Component component, boolean cleanupQuality) {
<span class="pc bpc" id="L311" title="2 of 4 branches missed.">        if (componentId == null || collectorItemIds == null) {</span>
            // Not all widgets gather data from collectors
<span class="nc" id="L313">            return null;</span>
        }
<span class="fc" id="L315">        associateCollectorItemsToComponent(collectorItemIds, false, component, cleanupQuality);</span>
<span class="fc" id="L316">        return component;</span>
    }

    private void associateCollectorItemsToComponent(List&lt;ObjectId&gt; collectorItemIds, boolean save, Component component, boolean cleanupQuality) {
<span class="fc" id="L320">        final String METHOD_NAME = &quot;DashboardServiceImpl.associateCollectorToComponent :&quot;;</span>
        //First: disable all collectorItems of the Collector TYPEs that came in with the request.
        //Second: remove all the collectorItem association of the Collector Type  that came in
        // incoming collector item collector types
<span class="fc" id="L324">        HashSet&lt;CollectorType&gt; incomingTypes = new HashSet&lt;&gt;();</span>
<span class="fc" id="L325">        HashMap&lt;ObjectId, CollectorItem&gt; toSaveCollectorItems = new HashMap&lt;&gt;();</span>
        // mapping collector item ID to collector item
<span class="fc" id="L327">        HashMap&lt;ObjectId, CollectorItem&gt; incomingCollectorItems = new HashMap&lt;&gt;();</span>
<span class="fc" id="L328">        ObjectId currentCollectorId = null;</span>
<span class="fc" id="L329">        Collector collector = null;</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">        for (ObjectId collectorItemId : collectorItemIds) {</span>
<span class="fc" id="L331">            CollectorItem collectorItem = collectorItemRepository.findOne(collectorItemId);</span>
<span class="fc" id="L332">            incomingCollectorItems.put(collectorItemId, collectorItem);</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">            if(collectorItem == null) {</span>
<span class="nc" id="L334">                LOG.warn(METHOD_NAME + &quot; Bad CollectorItemId passed in the request : &quot; + collectorItemId);</span>
<span class="nc" id="L335">                continue;</span>
            }
<span class="fc bfc" id="L337" title="All 4 branches covered.">            if(collector == null || currentCollectorId != collectorItem.getCollectorId()) {</span>
<span class="fc" id="L338">                collector = collectorRepository.findOne(collectorItem.getCollectorId());</span>
<span class="fc" id="L339">                currentCollectorId = collector.getId();</span>
            }
<span class="fc bfc" id="L341" title="All 2 branches covered.">            if (!incomingTypes.contains(collector.getCollectorType())) {</span>
<span class="fc" id="L342">                incomingTypes.add(collector.getCollectorType());</span>
                // get current collectorItems for a specific collector type in component
<span class="fc" id="L344">                List&lt;CollectorItem&gt; cItems = component.getCollectorItems(collector.getCollectorType());</span>
                // Save all collector items as disabled for now
<span class="fc bfc" id="L346" title="All 2 branches covered.">                if (!CollectionUtils.isEmpty(cItems)) {</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">                    for (CollectorItem ci : cItems) {</span>
                        //if item is orphaned, disable it. Otherwise keep it enabled.
<span class="fc bfc" id="L349" title="All 2 branches covered.">                        ci.setEnabled(!isLonely(ci, collector, component));</span>
<span class="fc" id="L350">                        toSaveCollectorItems.put(ci.getId(), ci);</span>
<span class="fc" id="L351">                    }</span>
                }
                // remove all collector items of a type
<span class="fc" id="L354">                component.getCollectorItems().remove(collector.getCollectorType());</span>
            }
<span class="fc" id="L356">        }</span>

        // If a collector type is within the code analysis widget, check to see if any of the remaining fields were passed values
<span class="fc bfc" id="L359" title="All 4 branches covered.">        if(incomingTypes.stream().anyMatch(QualityWidget::contains) &amp;&amp; cleanupQuality){</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">            if(!incomingTypes.contains(CollectorType.Test)){</span>
<span class="fc" id="L361">                component.getCollectorItems().remove(CollectorType.Test);</span>
            }
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">            if(!incomingTypes.contains(CollectorType.StaticSecurityScan)){</span>
<span class="fc" id="L364">                component.getCollectorItems().remove(CollectorType.StaticSecurityScan);</span>
            }
<span class="fc bfc" id="L366" title="All 2 branches covered.">            if(!incomingTypes.contains(CollectorType.CodeQuality)){</span>
<span class="fc" id="L367">                component.getCollectorItems().remove(CollectorType.CodeQuality);</span>
            }
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">            if(!incomingTypes.contains(CollectorType.LibraryPolicy)){</span>
<span class="nc" id="L370">                component.getCollectorItems().remove(CollectorType.LibraryPolicy);</span>
            }
        }

<span class="fc" id="L374">        currentCollectorId = null;</span>
<span class="fc" id="L375">        collector = null;</span>
        //Last step: add collector items that came in
<span class="fc bfc" id="L377" title="All 2 branches covered.">        for (ObjectId collectorItemId : collectorItemIds) {</span>
<span class="fc" id="L378">            CollectorItem collectorItem = incomingCollectorItems.get(collectorItemId);</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">            if(collectorItem == null) {</span>
<span class="nc" id="L380">                LOG.warn(METHOD_NAME + &quot; Bad CollectorItemId passed in the incoming request : &quot; + collectorItemId);</span>
<span class="nc" id="L381">                continue;</span>
            }
            //the new collector items must be set to true
<span class="fc" id="L384">            collectorItem.setEnabled(true);</span>
<span class="fc" id="L385">            CollectorItem existingCollectorItem = toSaveCollectorItems.get(collectorItem.getId());</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">            if ( (existingCollectorItem == null)</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                    || compareMaps(collectorItem.getOptions(), existingCollectorItem.getOptions()) ) {</span>
<span class="fc" id="L388">                collectorItem.setLastUpdated(System.currentTimeMillis());</span>
            }
<span class="fc bfc" id="L390" title="All 4 branches covered.">            if(collector == null || currentCollectorId != collectorItem.getCollectorId()) {</span>
<span class="fc" id="L391">                collector = collectorRepository.findOne(collectorItem.getCollectorId());</span>
<span class="fc" id="L392">                currentCollectorId = collector.getId();</span>
            }
<span class="fc" id="L394">            component.addCollectorItem(collector.getCollectorType(), collectorItem);</span>
<span class="fc" id="L395">            toSaveCollectorItems.put(collectorItemId, collectorItem);</span>
            // set transient collector property
<span class="fc" id="L397">            collectorItem.setCollector(collector);</span>
<span class="fc" id="L398">        }</span>

<span class="fc" id="L400">        collectorItemRepository.save(new HashSet&lt;&gt;(toSaveCollectorItems.values()));</span>
<span class="fc bfc" id="L401" title="All 2 branches covered.">        if(save){</span>
<span class="fc" id="L402">            componentRepository.save(component);</span>
        }
<span class="fc" id="L404">    }</span>

    /*
        Return true if two maps are different
     */
    protected boolean compareMaps (Map&lt;String, Object&gt; map1, Map&lt;String, Object&gt; map2) {
<span class="pc bpc" id="L410" title="2 of 4 branches missed.">        if (map1 == null || map2 == null)</span>
<span class="nc" id="L411">            return true;</span>

<span class="pc bpc" id="L413" title="1 of 2 branches missed.">        if (!map1.keySet().equals(map2.keySet()))</span>
<span class="nc" id="L414">            return true;</span>

<span class="fc" id="L416">        return map1.entrySet().stream().filter(value1 -&gt;</span>
<span class="fc bfc" id="L417" title="All 2 branches covered.">                !Objects.equals(value1.getValue(), map2.get(value1.getKey()))).findAny().isPresent();</span>
    }

    private boolean isLonely(CollectorItem item, Collector collector, Component component) {
<span class="fc" id="L421">        List&lt;Component&gt; components = customRepositoryQuery.findComponents(collector, item);</span>
        //if item is not attached to any component, it is orphaned.
<span class="fc bfc" id="L423" title="All 2 branches covered.">        if (CollectionUtils.isEmpty(components)) return true;</span>
        //if item is attached to more than 1 component, it is NOT orphaned
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">        if (components.size() &gt; 1) return false;</span>
        //if item is attached to ONLY 1 component it is the current one, it is going to be orphaned after this
<span class="nc" id="L427">        return (components.get(0).getId().equals(component.getId()));</span>
    }

    @Override
    public Widget addWidget(Dashboard dashboard, Widget widget) {
<span class="fc" id="L432">        widget.setId(ObjectId.get());</span>
<span class="fc" id="L433">        dashboard.getWidgets().add(widget);</span>
<span class="fc" id="L434">        dashboardRepository.save(dashboard);</span>
<span class="fc" id="L435">        return widget;</span>
    }

    @Override
    public Widget getWidget(Dashboard dashboard, ObjectId widgetId) {
<span class="fc" id="L440">        return Iterables.find(dashboard.getWidgets(), new WidgetByIdPredicate(widgetId));</span>
    }

    @Override
    public Widget updateWidget(Dashboard dashboard, Widget widget) {
<span class="fc" id="L445">        int index = dashboard.getWidgets().indexOf(widget);</span>
<span class="fc" id="L446">        dashboard.getWidgets().set(index, widget);</span>
        // update dashboard updateAt timestamp
<span class="fc" id="L448">        dashboard.setUpdatedAt(System.currentTimeMillis());</span>
<span class="fc" id="L449">        dashboardRepository.save(dashboard);</span>
<span class="fc" id="L450">        return widget;</span>
    }

    private static final class WidgetByIdPredicate implements Predicate&lt;Widget&gt; {
        private final ObjectId widgetId;

<span class="fc" id="L456">        public WidgetByIdPredicate(ObjectId widgetId) {</span>
<span class="fc" id="L457">            this.widgetId = widgetId;</span>
<span class="fc" id="L458">        }</span>

        @Override
        public boolean apply(Widget widget) {
<span class="fc" id="L462">            return widget.getId().equals(widgetId);</span>
        }
    }

    private Iterable&lt;Collector&gt; collectorsFromItems(Map&lt;CollectorType, List&lt;CollectorItem&gt;&gt; itemMap) {
<span class="fc" id="L467">        Set&lt;ObjectId&gt; collectorIds = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L468" title="All 2 branches covered.">        for (List&lt;CollectorItem&gt; collectorItems : itemMap.values()) {</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">            for (CollectorItem collectorItem : collectorItems) {</span>
<span class="fc" id="L470">                collectorIds.add(collectorItem.getCollectorId());</span>
<span class="fc" id="L471">            }</span>
<span class="fc" id="L472">        }</span>

<span class="fc" id="L474">        return collectorRepository.findAll(collectorIds);</span>
    }

    private Collector getCollector(final ObjectId collectorId, Iterable&lt;Collector&gt; collectors) {
<span class="fc" id="L478">        return Iterables.tryFind(collectors, new Predicate&lt;Collector&gt;() {</span>
            @Override
            public boolean apply(Collector collector) {
<span class="fc" id="L481">                return collector.getId().equals(collectorId);</span>
            }
<span class="fc" id="L483">        }).orNull();</span>
    }

    @Override
    public List&lt;Dashboard&gt; getOwnedDashboards() {
<span class="nc" id="L488">        Owner owner = new Owner(AuthenticationUtil.getUsernameFromContext(), AuthenticationUtil.getAuthTypeFromContext());</span>
<span class="nc" id="L489">        List&lt;Dashboard&gt; findByOwnersList = dashboardRepository.findByOwners(owner);</span>
<span class="nc" id="L490">        getAppAndComponentNames(findByOwnersList);</span>
<span class="nc" id="L491">        return findByOwnersList.stream().distinct().collect(Collectors.toList());</span>
    }

    @Override
    public List&lt;ObjectId&gt; getOwnedDashboardsObjectIds() {
<span class="nc" id="L496">        List&lt;ObjectId&gt; dashboardIdList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L497">        List&lt;Dashboard&gt; ownedDashboards =  getOwnedDashboards();</span>

<span class="nc bnc" id="L499" title="All 2 branches missed.">        for(Dashboard dashboard: ownedDashboards){</span>
<span class="nc" id="L500">            dashboardIdList.add(dashboard.getId());</span>
<span class="nc" id="L501">        }</span>

<span class="nc" id="L503">        return dashboardIdList;</span>
    }
    @Override
    public Iterable&lt;Owner&gt; getOwners(ObjectId id) {
<span class="nc" id="L507">        Dashboard dashboard = get(id);</span>
<span class="nc" id="L508">        return dashboard.getOwners();</span>
    }

    @Override
    public Iterable&lt;Owner&gt; updateOwners(ObjectId dashboardId, Iterable&lt;Owner&gt; owners) {
<span class="fc bfc" id="L513" title="All 2 branches covered.">        for(Owner owner : owners) {</span>
<span class="fc" id="L514">            String username = owner.getUsername();</span>
<span class="fc" id="L515">            AuthType authType = owner.getAuthType();</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">            if (!userInfoService.isUserValid(username, authType)) {</span>
<span class="fc" id="L517">                throw new UserNotFoundException(username, authType);</span>
            }
<span class="fc" id="L519">        }</span>

<span class="fc" id="L521">        Dashboard dashboard = dashboardRepository.findOne(dashboardId);</span>
<span class="fc" id="L522">        dashboard.setOwners(Lists.newArrayList(owners));</span>
<span class="fc" id="L523">        Dashboard result = dashboardRepository.save(dashboard);</span>

<span class="fc" id="L525">        return result.getOwners();</span>
    }

    @Override
    public String getDashboardOwner(String dashboardTitle) {
<span class="nc" id="L530">        String dashboardOwner=dashboardRepository.findByTitle(dashboardTitle).get(0).getOwner();</span>

<span class="nc" id="L532">        return dashboardOwner;</span>
    }

    @SuppressWarnings(&quot;unused&quot;)
    private DashboardType getDashboardType(Dashboard dashboard) {
<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (dashboard.getType() != null) {</span>
<span class="nc" id="L538">            return dashboard.getType();</span>
        }
<span class="nc" id="L540">        return DashboardType.Team;</span>
    }

    @Override
    public Component getComponent(ObjectId componentId){

<span class="fc" id="L546">        Component component = componentRepository.findOne(componentId);</span>
<span class="fc" id="L547">        return component;</span>
    }
    @Override
    public Dashboard updateDashboardBusinessItems(ObjectId dashboardId, Dashboard request) throws HygieiaException {
<span class="fc" id="L551">        Dashboard dashboard = get(dashboardId);</span>
<span class="fc" id="L552">        String updatedBusServiceName = request.getConfigurationItemBusServName();</span>
<span class="fc" id="L553">        String updatedBusApplicationName = request.getConfigurationItemBusAppName();</span>

<span class="pc bpc" id="L555" title="1 of 2 branches missed.">        if(StringUtils.isEmpty(updatedBusServiceName)){</span>

<span class="nc" id="L557">            dashboard.setConfigurationItemBusServName(null);</span>
        }else{
<span class="fc" id="L559">            Cmdb cmdb = cmdbService.configurationItemByConfigurationItem(updatedBusServiceName);</span>
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">            if(cmdb != null){</span>

<span class="fc" id="L562">                dashboard.setConfigurationItemBusServName(cmdb.getConfigurationItem());</span>
            }
        }
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">        if(StringUtils.isEmpty(updatedBusApplicationName)){</span>

<span class="nc" id="L567">            dashboard.setConfigurationItemBusAppName(null);</span>
        }else{
<span class="fc" id="L569">            Cmdb cmdb = cmdbService.configurationItemByConfigurationItem(updatedBusApplicationName);</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">            if(cmdb != null){</span>

<span class="fc" id="L572">                dashboard.setConfigurationItemBusAppName(cmdb.getConfigurationItem());</span>
            }
        }

<span class="fc" id="L576">        return update(dashboard);</span>
    }
    @Override
    public DataResponse&lt;Iterable&lt;Dashboard&gt;&gt; getByBusinessService(String app) {
<span class="nc" id="L580">        Cmdb cmdb =  cmdbService.configurationItemByConfigurationItem(app);</span>
<span class="nc" id="L581">        Iterable&lt;Dashboard&gt; rt = null;</span>

<span class="nc bnc" id="L583" title="All 2 branches missed.">        if(cmdb != null){</span>
<span class="nc" id="L584">            rt = dashboardRepository.findAllByConfigurationItemBusServName(cmdb.getConfigurationItem());</span>
        }
<span class="nc" id="L586">        return new DataResponse&lt;&gt;(rt, System.currentTimeMillis());</span>
    }
    @Override
    public DataResponse&lt;Iterable&lt;Dashboard&gt;&gt; getByBusinessApplication(String component) {
<span class="nc" id="L590">        Cmdb cmdb =  cmdbService.configurationItemByConfigurationItem(component);</span>
<span class="nc" id="L591">        Iterable&lt;Dashboard&gt; rt = null;</span>

<span class="nc bnc" id="L593" title="All 2 branches missed.">        if(cmdb != null){</span>
<span class="nc" id="L594">            rt = dashboardRepository.findAllByConfigurationItemBusAppName(cmdb.getConfigurationItem());</span>
        }
<span class="nc" id="L596">        return new DataResponse&lt;&gt;(rt, System.currentTimeMillis());</span>
    }
    @Override
    public DataResponse&lt;Iterable&lt;Dashboard&gt;&gt; getByServiceAndApplication(String component, String app) {
<span class="nc" id="L600">        Cmdb cmdbCompItem =  cmdbService.configurationItemByConfigurationItem(component);</span>
<span class="nc" id="L601">        Cmdb cmdbAppItem =  cmdbService.configurationItemByConfigurationItem(app);</span>
<span class="nc" id="L602">        Iterable&lt;Dashboard&gt; rt = null;</span>

<span class="nc bnc" id="L604" title="All 4 branches missed.">        if(cmdbAppItem != null &amp;&amp; cmdbCompItem != null){</span>
<span class="nc" id="L605">            rt = dashboardRepository.findAllByConfigurationItemBusServNameAndConfigurationItemBusAppName(cmdbAppItem.getConfigurationItem(),cmdbCompItem.getConfigurationItem());</span>
        }
<span class="nc" id="L607">        return new DataResponse&lt;&gt;(rt, System.currentTimeMillis());</span>
    }
    @Override
    public  List&lt;Dashboard&gt; getByTitle(String title) {
<span class="fc" id="L611">        List&lt;Dashboard&gt; dashboard = dashboardRepository.findByTitle(title);</span>

<span class="fc" id="L613">        return dashboard;</span>
    }

    @Override
    public Dashboard updateDashboardWidgets(ObjectId dashboardId, Dashboard request) throws HygieiaException {
<span class="fc" id="L618">        Dashboard dashboard = get(dashboardId);</span>
<span class="fc" id="L619">        List&lt;String&gt; existingActiveWidgets = dashboard.getActiveWidgets();</span>
<span class="fc" id="L620">        List&lt;Component&gt; components = dashboard.getApplication().getComponents();</span>
<span class="fc" id="L621">        List&lt;String&gt; widgetToDelete =  findUpdateCollectorItems(existingActiveWidgets,request.getActiveWidgets());</span>
<span class="fc" id="L622">        List&lt;Widget&gt; widgets = dashboard.getWidgets();</span>
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">        ObjectId componentId = components.get(0)!=null?components.get(0).getId():null;</span>
<span class="fc" id="L624">        List&lt;Integer&gt; indexList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L625">        List&lt;CollectorType&gt; collectorTypesToDelete = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L626">        List&lt;Widget&gt; updatedWidgets = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L628" title="1 of 2 branches missed.">        for (String widgetName: widgetToDelete) {</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">            for (Widget widget:widgets) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">                if(widgetName.equalsIgnoreCase(widget.getName())){</span>
<span class="nc" id="L631">                    int widgetIndex = widgets.indexOf(widget);</span>
<span class="nc" id="L632">                    indexList.add(widgetIndex);</span>
<span class="nc" id="L633">                    collectorTypesToDelete.add(findCollectorType(widgetName));</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">                    if(widgetName.equalsIgnoreCase(&quot;codeanalysis&quot;)){</span>
<span class="nc" id="L635">                        collectorTypesToDelete.add(CollectorType.CodeQuality);</span>
<span class="nc" id="L636">                        collectorTypesToDelete.add(CollectorType.StaticSecurityScan);</span>
<span class="nc" id="L637">                        collectorTypesToDelete.add(CollectorType.LibraryPolicy);</span>
<span class="nc" id="L638">                        collectorTypesToDelete.add(CollectorType.Test);</span>
                    }
                }
<span class="nc" id="L641">            }</span>
<span class="nc" id="L642">        }</span>
        //iterate through index and remove widgets
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">        for (Integer i:indexList) {</span>
<span class="nc" id="L645">            widgets.set(i,null);</span>
<span class="nc" id="L646">        }</span>
<span class="pc bpc" id="L647" title="1 of 2 branches missed.">        for (Widget w:widgets) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">            if(w!=null)</span>
<span class="nc" id="L649">                updatedWidgets.add(w);</span>
<span class="nc" id="L650">        }</span>
<span class="fc" id="L651">        dashboard.setWidgets(updatedWidgets);</span>
<span class="fc" id="L652">        dashboard.setActiveWidgets(request.getActiveWidgets());</span>
<span class="fc" id="L653">        dashboard = update(dashboard);</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">        if(componentId!=null){</span>
<span class="nc" id="L655">            com.capitalone.dashboard.model.Component component = componentRepository.findOne(componentId);</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">            for (CollectorType cType :collectorTypesToDelete) {</span>
<span class="nc" id="L657">                component.getCollectorItems().remove(cType);</span>
<span class="nc" id="L658">            }</span>
<span class="nc" id="L659">            componentRepository.save(component);</span>
        }
<span class="fc" id="L661">        return dashboard;</span>
    }


    @Override
    public Component deleteWidget(Dashboard dashboard, Widget widget,ObjectId componentId, List&lt;ObjectId&gt; collectorItemIds, boolean cleanupQuality) {
<span class="fc" id="L667">        String widgetName = widget.getName();</span>
<span class="fc" id="L668">        List&lt;CollectorType&gt; collectorTypesToDelete = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L669">        CollectorType cType = findCollectorType(widgetName);</span>
<span class="fc" id="L670">        collectorTypesToDelete.add(cType);</span>

<span class="pc bpc" id="L672" title="1 of 2 branches missed.">        if (componentId == null) {</span>
<span class="nc" id="L673">            return null;</span>
        }
<span class="fc" id="L675">        Component component = getComponent(componentId);</span>

<span class="fc bfc" id="L677" title="All 2 branches covered.">        if(widgetName.equalsIgnoreCase(&quot;codeanalysis&quot;)){</span>
<span class="pc bpc" id="L678" title="1 of 2 branches missed.">            if (cleanupQuality) {</span>
<span class="nc" id="L679">                collectorTypesToDelete.add(CollectorType.CodeQuality);</span>
<span class="nc" id="L680">                collectorTypesToDelete.add(CollectorType.StaticSecurityScan);</span>
<span class="nc" id="L681">                collectorTypesToDelete.add(CollectorType.LibraryPolicy);</span>
<span class="nc" id="L682">                collectorTypesToDelete.add(CollectorType.Test);</span>
            } else {
                // Find which collector item under quality widget to delete
                // from collectorItemIds, find collectortype containing matching collector item id, then add to collectorTypesToDelete
<span class="fc" id="L686">                CollectorType foundType = searchCollectorTypeByCollectorItemIds(component, collectorItemIds);</span>
                // if match found (should always be the case)
<span class="pc bpc" id="L688" title="1 of 2 branches missed.">                if (foundType != null) {</span>
<span class="nc" id="L689">                    collectorTypesToDelete.add(foundType);</span>
                }
            }
        }

<span class="fc bfc" id="L694" title="All 2 branches covered.">        for (CollectorType c:collectorTypesToDelete) {</span>
<span class="fc" id="L695">            component.getCollectorItems().remove(c);</span>
<span class="fc" id="L696">        }</span>

<span class="fc" id="L698">        int index = dashboard.getWidgets().indexOf(widget);</span>
        // if widget is not quality, is quality for old UI, or only has one collector type in quality, then delete entire widget from dashboard
<span class="fc bfc" id="L700" title="All 2 branches covered.">        if (!widgetName.equalsIgnoreCase(&quot;codeanalysis&quot;)</span>
<span class="pc bpc" id="L701" title="2 of 4 branches missed.">                || (widgetName.equalsIgnoreCase(&quot;codeanalysis&quot;) &amp;&amp; cleanupQuality)</span>
<span class="pc bpc" id="L702" title="1 of 2 branches missed.">                || !hasMultipleQualityComponents(component.getCollectorItems())) {</span>
<span class="fc" id="L703">            dashboardUpdate(dashboard, index);</span>
        }

<span class="fc" id="L706">        componentRepository.save(component);</span>
<span class="fc" id="L707">        return component;</span>
    }

    private void dashboardUpdate(Dashboard dashboard, int index) {
<span class="fc bfc" id="L711" title="All 2 branches covered.">        if(index!=-1){</span>
<span class="fc" id="L712">            dashboard.getWidgets().set(index, null);</span>
<span class="fc" id="L713">            List&lt;Widget&gt; updatedWidgets = dashboard.getWidgets().stream().filter(Objects::nonNull).collect(Collectors.toList());</span>
<span class="fc" id="L714">            dashboard.setWidgets(updatedWidgets);</span>
<span class="fc" id="L715">            dashboardRepository.save(dashboard);</span>
        }
<span class="fc" id="L717">    }</span>

    private CollectorType searchCollectorTypeByCollectorItemIds(Component component, List&lt;ObjectId&gt; collectorItemIds) {
<span class="fc" id="L720">        Map&lt;CollectorType, List&lt;CollectorItem&gt;&gt; componentCIs = component.getCollectorItems();</span>
        // once find first match, return associated CollectorType
<span class="fc bfc" id="L722" title="All 2 branches covered.">        for (Map.Entry&lt;CollectorType, List&lt;CollectorItem&gt;&gt; componentCI : componentCIs.entrySet()) {</span>
<span class="fc bfc" id="L723" title="All 2 branches covered.">            for (ObjectId colItemId : collectorItemIds) {</span>
<span class="pc bpc" id="L724" title="1 of 2 branches missed.">                if (componentCI.getValue().stream().filter(ci -&gt; ci.getId().equals(colItemId)).count() &gt; 0) {</span>
<span class="nc" id="L725">                    return componentCI.getKey();</span>
                }
<span class="fc" id="L727">            }</span>
<span class="fc" id="L728">        }</span>

<span class="fc" id="L730">        return null;</span>
    }

    private boolean hasMultipleQualityComponents(Map&lt;CollectorType, List&lt;CollectorItem&gt;&gt; componentCIs) {
<span class="pc bpc" id="L734" title="1 of 2 branches missed.">        return componentCIs.keySet().stream().anyMatch(QualityWidget::contains) ? true : false;</span>
    }

    @Override
    public void deleteWidget(Dashboard dashboard, CollectorType collectorType){
<span class="fc bfc" id="L739" title="All 2 branches covered.">        if(CollectionUtils.isNotEmpty(dashboard.getWidgets())){</span>
<span class="fc" id="L740">            String widgetName = findWidgetName(collectorType);</span>
<span class="fc" id="L741">            List&lt;String&gt; widgetNames = dashboard.getWidgets().stream().map(widget-&gt; widget.getName()).collect(Collectors.toList());</span>
<span class="fc" id="L742">            int index = widgetNames.indexOf(widgetName);</span>
<span class="fc" id="L743">            dashboardUpdate(dashboard,index);</span>
        }
<span class="fc" id="L745">    }</span>

    private List&lt;String&gt; findUpdateCollectorItems(List&lt;String&gt; existingWidgets,List&lt;String&gt; currentWidgets){
<span class="pc bnc" id="L748" title="All 2 branches missed.">        List&lt;String&gt; result = existingWidgets.stream().filter(elem -&gt; !currentWidgets.contains(elem)).collect(Collectors.toList());</span>
<span class="fc" id="L749">        return result;</span>
    }

    private static CollectorType findCollectorType(String widgetName){
<span class="pc bpc" id="L753" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(BUILD)) return CollectorType.Build;</span>
<span class="pc bpc" id="L754" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(FEATURE)) return CollectorType.AgileTool;</span>
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(DEPLOY)) return CollectorType.Deployment;</span>
<span class="pc bpc" id="L756" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(REPO)) return CollectorType.SCM;</span>
<span class="pc bpc" id="L757" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(PERFORMANCE)) return CollectorType.AppPerformance;</span>
<span class="pc bpc" id="L758" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(CLOUD)) return CollectorType.Cloud;</span>
<span class="pc bpc" id="L759" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(CHATOPS)) return CollectorType.ChatOps;</span>
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(TEST)) return CollectorType.Test;</span>
<span class="pc bpc" id="L761" title="1 of 2 branches missed.">        if(widgetName.equalsIgnoreCase(INFRA_SCAN)) return CollectorType.InfrastructureScan;</span>
<span class="fc" id="L762">        return null;</span>
    }

    private static String findWidgetName(CollectorType collectorType) {
<span class="pc bpc" id="L766" title="8 of 10 branches missed.">        switch (collectorType) {</span>
            case Build:
<span class="nc" id="L768">                return BUILD;</span>
            case AgileTool:
<span class="nc" id="L770">                return FEATURE;</span>
            case Deployment:
<span class="nc" id="L772">                return DEPLOY;</span>
            case SCM:
<span class="fc" id="L774">                return REPO;</span>
            case AppPerformance:
<span class="nc" id="L776">                return PERFORMANCE;</span>
            case Cloud:
<span class="nc" id="L778">                return CLOUD;</span>
            case ChatOps:
<span class="nc" id="L780">                return CHATOPS;</span>
            case CodeQuality:
            case StaticSecurityScan:
            case LibraryPolicy:
            case Test:
<span class="fc" id="L785">                return CODEANALYSIS;</span>
            case InfrastructureScan:
<span class="nc" id="L787">                return INFRA_SCAN;</span>
            default:
<span class="nc" id="L789">                return null;</span>
        }

    }




    private void getAppAndComponentNames(List&lt;Dashboard&gt; findByOwnersList) {
<span class="nc bnc" id="L798" title="All 2 branches missed.">        for(Dashboard dashboard: findByOwnersList){</span>


<span class="nc" id="L801">            String appName = dashboard.getConfigurationItemBusServName();</span>
<span class="nc" id="L802">            String compName = dashboard.getConfigurationItemBusAppName();</span>
<span class="nc" id="L803">            setAppAndComponentNameToDashboard(dashboard, appName, compName);</span>
<span class="nc" id="L804">        }</span>
<span class="nc" id="L805">    }</span>

    /**
     *  Sets business service, business application and valid flag for each to the give Dashboard
     * @param dashboard
     * @param appName
     * @param compName
     */
    private void setAppAndComponentNameToDashboard(Dashboard dashboard, String appName, String compName) {
<span class="pc bpc" id="L814" title="1 of 4 branches missed.">        if(appName != null &amp;&amp; !&quot;&quot;.equals(appName)){</span>

<span class="fc" id="L816">            Cmdb cmdb =  cmdbService.configurationItemByConfigurationItem(appName);</span>
<span class="pc bpc" id="L817" title="1 of 2 branches missed.">            if(cmdb !=null) {</span>
<span class="fc" id="L818">                dashboard.setConfigurationItemBusServName(cmdb.getConfigurationItem());</span>
<span class="fc" id="L819">                dashboard.setValidServiceName(cmdb.isValidConfigItem());</span>
            }
        }
<span class="pc bpc" id="L822" title="1 of 4 branches missed.">        if(compName != null &amp;&amp; !&quot;&quot;.equals(compName)){</span>
<span class="fc" id="L823">            Cmdb cmdb = cmdbService.configurationItemByConfigurationItem(compName);</span>
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">            if(cmdb !=null) {</span>
<span class="fc" id="L825">                dashboard.setConfigurationItemBusAppName(cmdb.getConfigurationItem());</span>
<span class="fc" id="L826">                dashboard.setValidAppName(cmdb.isValidConfigItem());</span>
            }
        }
<span class="fc" id="L829">    }</span>

    /**
     *  Takes Dashboard and checks to see if there is an existing Dashboard with the same business service and business application
     *  Throws error if found
     * @param dashboard
     * @throws HygieiaException
     */
    private void duplicateDashboardErrorCheck(Dashboard dashboard) throws HygieiaException {
<span class="fc" id="L838">        String appName = dashboard.getConfigurationItemBusServName();</span>
<span class="fc" id="L839">        String compName = dashboard.getConfigurationItemBusAppName();</span>

<span class="pc bpc" id="L841" title="3 of 8 branches missed.">        if(appName != null &amp;&amp; !appName.isEmpty() &amp;&amp; compName != null &amp;&amp; !compName.isEmpty()){</span>
<span class="fc" id="L842">            Dashboard existingDashboard = dashboardRepository.findByConfigurationItemBusServNameIgnoreCaseAndConfigurationItemBusAppNameIgnoreCase(appName, compName);</span>
<span class="pc bpc" id="L843" title="3 of 4 branches missed.">            if(existingDashboard != null &amp;&amp; !existingDashboard.getId().equals(dashboard.getId())){</span>
<span class="nc" id="L844">                throw new HygieiaException(&quot;Existing Dashboard: &quot; + existingDashboard.getTitle(), HygieiaException.DUPLICATE_DATA);</span>
            }
        }
<span class="fc" id="L847">    }</span>

    /**
     * Get all dashboards filtered by title and Pageable ( default page size = 10)
     *
     * @param title Title of Dashboard
     * @param type Type of Dashboard
     * @param pageable Pagination Object
     * @return Page&lt;Dashboard&gt; Page of Dashboards
     */
    @Override
    public Page&lt;Dashboard&gt; getDashboardByTitleWithFilter(String title, String type, Pageable pageable) {
<span class="fc" id="L859">        Page&lt;Dashboard&gt; dashboardItems = null;</span>
<span class="pc bpc" id="L860" title="4 of 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L861">            dashboardItems = dashboardRepository.findAllByTypeContainingIgnoreCaseAndTitleContainingIgnoreCase(type, title, pageable);</span>
        } else {
<span class="fc" id="L863">            dashboardItems = dashboardRepository.findAllByTitleContainingIgnoreCase(title, pageable);</span>
        }

<span class="fc" id="L866">        return dashboardItems;</span>
    }

    /**
     * Get count of all dashboards filtered by title
     *
     * @param title Title of Dashboard
     * @param type Type of Dashboard
     * @return Integer Count of Dashboards
     */
    @Override
    public Integer getAllDashboardsByTitleCount(String title, String type) {
<span class="fc" id="L878">        List&lt;Dashboard&gt; dashboards = null;</span>
<span class="pc bpc" id="L879" title="4 of 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L880">            dashboards = dashboardRepository.findAllByTypeContainingIgnoreCaseAndTitleContainingIgnoreCase(type, title);</span>
        } else {
<span class="fc" id="L882">            dashboards = dashboardRepository.findAllByTitleContainingIgnoreCase(title);</span>
        }
<span class="pc bpc" id="L884" title="1 of 2 branches missed.">        return dashboards != null ? dashboards.size() : 0;</span>
    }

    /**
     * Get count of all dashboards, use dashboard type if supplied
     *
     * @param type Type of the Dashboard
     * @return long
     */
    @Override
    public long count(String type) {
<span class="nc bnc" id="L895" title="All 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L896">            return dashboardRepository.countByTypeContainingIgnoreCase(type);</span>
        } else {
<span class="nc" id="L898">            return dashboardRepository.count();</span>
        }
    }

    /**
     * Get all dashboards with page size (default = 10)
     *
     * @param type Type of Dashboard
     * @param page size
     * @return List of dashboards
     */
    @Override
    public Page&lt;Dashboard&gt; findDashboardsByPage(String type, Pageable page) {
<span class="nc bnc" id="L911" title="All 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L912">            return dashboardRepository.findAllByTypeContainingIgnoreCase(type, page);</span>
        }
<span class="nc" id="L914">        return dashboardRepository.findAll(page);</span>
    }

    /**
     * Get page size
     *
     * @return Integer
     */
    @Override
    public int getPageSize() {
<span class="nc" id="L924">        return settings.getPageSize();</span>
    }

    @Override
    public Page&lt;Dashboard&gt; findMyDashboardsByPage(String type, Pageable page){
<span class="nc" id="L929">        Owner owner = new Owner(AuthenticationUtil.getUsernameFromContext(), AuthenticationUtil.getAuthTypeFromContext());</span>
<span class="nc" id="L930">        Page&lt;Dashboard&gt; ownersList = null;</span>

<span class="nc bnc" id="L932" title="All 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L933">            ownersList = dashboardRepository.findByOwnersAndTypeContainingIgnoreCase(owner, type, page);</span>
        } else {
<span class="nc" id="L935">            ownersList = dashboardRepository.findByOwners(owner, page);</span>
        }
<span class="nc bnc" id="L937" title="All 2 branches missed.">        for (Dashboard dashboard: ownersList) {</span>
<span class="nc" id="L938">            String appName = dashboard.getConfigurationItemBusServName();</span>
<span class="nc" id="L939">            String compName = dashboard.getConfigurationItemBusAppName();</span>
<span class="nc" id="L940">            setAppAndComponentNameToDashboard(dashboard, appName, compName);</span>
<span class="nc" id="L941">        }</span>
<span class="nc" id="L942">        return ownersList;</span>
    }

    @Override
    public long myDashboardsCount(String type){
<span class="nc" id="L947">        Owner owner = new Owner(AuthenticationUtil.getUsernameFromContext(), AuthenticationUtil.getAuthTypeFromContext());</span>
<span class="nc" id="L948">        List&lt;Dashboard&gt; ownersList = null;</span>
<span class="nc bnc" id="L949" title="All 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L950">            ownersList = dashboardRepository.findByOwnersAndTypeContainingIgnoreCase(owner, type);</span>
        } else {
<span class="nc" id="L952">            ownersList = dashboardRepository.findByOwners(owner);</span>
        }
<span class="nc bnc" id="L954" title="All 2 branches missed.">        return ownersList!=null?ownersList.size():0;</span>
    }

    @Override
    public int getMyDashboardsByTitleCount(String title, String type){
<span class="nc" id="L959">        Owner owner = new Owner(AuthenticationUtil.getUsernameFromContext(), AuthenticationUtil.getAuthTypeFromContext());</span>
<span class="nc" id="L960">        List&lt;Dashboard&gt; dashboards = null;</span>
<span class="nc bnc" id="L961" title="All 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L962">            dashboards = dashboardRepository.findByOwnersAndTypeContainingIgnoreCaseAndTitleContainingIgnoreCase(owner,type,title);</span>
        } else {
<span class="nc" id="L964">            dashboards = dashboardRepository.findByOwnersAndTitleContainingIgnoreCase(owner,title);</span>
        }
<span class="nc bnc" id="L966" title="All 2 branches missed.">        return dashboards!=null?dashboards.size():0;</span>
    }

    @Override
    public Page&lt;Dashboard&gt; getMyDashboardByTitleWithFilter(String title, String type, Pageable pageable) {
<span class="nc" id="L971">        Owner owner = new Owner(AuthenticationUtil.getUsernameFromContext(), AuthenticationUtil.getAuthTypeFromContext());</span>
<span class="nc" id="L972">        Page&lt;Dashboard&gt; ownersList = null;</span>
<span class="nc bnc" id="L973" title="All 6 branches missed.">        if ((type != null) &amp;&amp; (!type.isEmpty()) &amp;&amp; (!UNDEFINED.equalsIgnoreCase(type))) {</span>
<span class="nc" id="L974">            ownersList = dashboardRepository.findByOwnersAndTypeContainingIgnoreCaseAndTitleContainingIgnoreCase(owner,type,title,pageable);</span>
        } else {
<span class="nc" id="L976">            ownersList = dashboardRepository.findByOwnersAndTitleContainingIgnoreCase(owner,title,pageable);</span>
        }

<span class="nc bnc" id="L979" title="All 2 branches missed.">        for (Dashboard dashboard: ownersList) {</span>
<span class="nc" id="L980">            String appName = dashboard.getConfigurationItemBusServName();</span>
<span class="nc" id="L981">            String compName = dashboard.getConfigurationItemBusAppName();</span>
<span class="nc" id="L982">            setAppAndComponentNameToDashboard(dashboard, appName, compName);</span>
<span class="nc" id="L983">        }</span>
<span class="nc" id="L984">        return ownersList;</span>
    }


    @Override
    public Dashboard updateScoreSettings(ObjectId dashboardId, boolean scoreEnabled, ScoreDisplayType scoreDisplay) {
<span class="fc" id="L990">        Dashboard dashboard = get(dashboardId);</span>
<span class="pc bpc" id="L991" title="1 of 2 branches missed.">        if ((scoreEnabled == dashboard.isScoreEnabled()) &amp;&amp;</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">                (scoreDisplay == dashboard.getScoreDisplay())) {</span>
<span class="nc" id="L993">            return null;</span>
        }

<span class="fc" id="L996">        dashboard.setScoreEnabled(scoreEnabled);</span>
<span class="fc" id="L997">        dashboard.setScoreDisplay(scoreDisplay);</span>
<span class="fc" id="L998">        Dashboard savedDashboard = dashboardRepository.save(dashboard);</span>
<span class="fc" id="L999">        this.scoreDashboardService.editScoreForDashboard(savedDashboard);</span>
<span class="fc" id="L1000">        return savedDashboard;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>