<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestResultServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.capitalone.dashboard:api</a> &gt; <a href="index.source.html" class="el_package">com.capitalone.dashboard.service</a> &gt; <span class="el_source">TestResultServiceImpl.java</span></div><h1>TestResultServiceImpl.java</h1><pre class="source lang-java linenums">package com.capitalone.dashboard.service;

import com.capitalone.dashboard.misc.HygieiaException;
import com.capitalone.dashboard.model.*;
import com.capitalone.dashboard.model.quality.CucumberJsonReport;
import com.capitalone.dashboard.model.quality.JunitXmlReport;
import com.capitalone.dashboard.model.quality.JunitXmlReportV2;
import com.capitalone.dashboard.repository.BuildRepository;
import com.capitalone.dashboard.repository.CollectorItemRepository;
import com.capitalone.dashboard.repository.CollectorRepository;
import com.capitalone.dashboard.repository.ComponentRepository;
import com.capitalone.dashboard.repository.TestResultRepository;
import com.capitalone.dashboard.request.CollectorRequest;
import com.capitalone.dashboard.request.PerfTestDataCreateRequest;
import com.capitalone.dashboard.request.TestDataCreateRequest;
import com.capitalone.dashboard.settings.ApiSettings;
import com.capitalone.dashboard.util.HygieiaUtils;
import com.capitalone.dashboard.util.TestResultConstants;
import com.google.common.collect.Lists;
import com.google.gson.Gson;
import com.querydsl.core.BooleanBuilder;
import hygieia.transformer.CucumberJsonToTestCapabilityTransformer;
import hygieia.transformer.JunitXmlToTestCapabilityTransformer;
import hygieia.transformer.JunitXmlToTestCapabilityTransformerV2;
import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;
import org.bson.types.ObjectId;
import org.joda.time.format.DateTimeFormat;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Unmarshaller;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.Base64;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
public class TestResultServiceImpl implements TestResultService {

    private final TestResultRepository testResultRepository;
    private final ComponentRepository componentRepository;
    private final CollectorRepository collectorRepository;
    private final CollectorItemRepository collectorItemRepository;
    private final BuildRepository buildRepository;
    private final CollectorService collectorService;
    private final CmdbService cmdbService;
    private final ApiSettings apiSettings;

<span class="fc" id="L61">    private static final Logger LOGGER = Logger.getLogger(ApiTokenServiceImpl.class);</span>

    @Autowired
    public TestResultServiceImpl(TestResultRepository testResultRepository,
                                 ComponentRepository componentRepository,
                                 CollectorRepository collectorRepository,
                                 BuildRepository buildRepository,
                                 CollectorItemRepository collectorItemRepository,
                                 CollectorService collectorService,
                                 CmdbService cmdbService,
<span class="fc" id="L71">                                 ApiSettings apiSettings) {</span>
<span class="fc" id="L72">        this.testResultRepository = testResultRepository;</span>
<span class="fc" id="L73">        this.componentRepository = componentRepository;</span>
<span class="fc" id="L74">        this.collectorRepository = collectorRepository;</span>
<span class="fc" id="L75">        this.buildRepository = buildRepository;</span>
<span class="fc" id="L76">        this.collectorItemRepository = collectorItemRepository;</span>
<span class="fc" id="L77">        this.collectorService = collectorService;</span>
<span class="fc" id="L78">        this.cmdbService = cmdbService;</span>
<span class="fc" id="L79">        this.apiSettings = apiSettings;</span>
<span class="fc" id="L80">    }</span>

    @Override
    public DataResponse&lt;Iterable&lt;TestResult&gt;&gt; search(com.capitalone.dashboard.request.TestResultRequest request) {
<span class="fc" id="L84">        Component component = componentRepository.findOne(request.getComponentId());</span>

<span class="pc bpc" id="L86" title="1 of 4 branches missed.">        if ((component == null) || !component.getCollectorItems().containsKey(CollectorType.Test)) {</span>
<span class="fc" id="L87">            return new DataResponse&lt;&gt;(null, 0L);</span>
        }
<span class="nc" id="L89">        List&lt;TestResult&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L90">        validateAllCollectorItems(request, component, result);</span>
        //One collector per Type. get(0) is hardcoded.
<span class="nc bnc" id="L92" title="All 4 branches missed.">        if (!CollectionUtils.isEmpty(component.getCollectorItems().get(CollectorType.Test)) &amp;&amp; (component.getCollectorItems().get(CollectorType.Test).get(0) != null)) {</span>
<span class="nc" id="L93">            Collector collector = collectorRepository.findOne(component.getCollectorItems().get(CollectorType.Test).get(0).getCollectorId());</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (collector != null) {</span>
<span class="nc" id="L95">                return new DataResponse&lt;&gt;(pruneToDepth(result, request.getDepth()), collector.getLastExecuted());</span>
            }
        }

<span class="nc" id="L99">        return new DataResponse&lt;&gt;(null, 0L);</span>
    }



    private void validateAllCollectorItems(com.capitalone.dashboard.request.TestResultRequest request, Component component, List&lt;TestResult&gt; result) {
        // add all test result repos
<span class="nc" id="L106">        component.getCollectorItems().get(CollectorType.Test).forEach(item -&gt; {</span>
<span class="nc" id="L107">            QTestResult testResult = new QTestResult(&quot;testResult&quot;);</span>
<span class="nc" id="L108">            BooleanBuilder builder = new BooleanBuilder();</span>
<span class="nc" id="L109">            builder.and(testResult.collectorItemId.eq(item.getId()));</span>
<span class="nc" id="L110">            validateStartDateRange(request, testResult, builder);</span>
<span class="nc" id="L111">            validateEndDateRange(request, testResult, builder);</span>
<span class="nc" id="L112">            validateDurationRange(request, testResult, builder);</span>
<span class="nc" id="L113">            validateTestCapabilities(request, testResult, builder);</span>
<span class="nc" id="L114">            addAllTestResultRepositories(request, result, testResult, builder);</span>
<span class="nc" id="L115">        });</span>
<span class="nc" id="L116">    }</span>

    private void addAllTestResultRepositories(com.capitalone.dashboard.request.TestResultRequest request, List&lt;TestResult&gt; result, QTestResult testResult, BooleanBuilder builder) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (request.getMax() == null) {</span>
<span class="nc" id="L120">            result.addAll(Lists.newArrayList(testResultRepository.findAll(builder.getValue(), testResult.timestamp.desc())));</span>
        } else {
<span class="nc" id="L122">            PageRequest pageRequest = new PageRequest(0, request.getMax(), Sort.Direction.DESC, &quot;timestamp&quot;);</span>
<span class="nc" id="L123">            result.addAll(Lists.newArrayList(testResultRepository.findAll(builder.getValue(), pageRequest).getContent()));</span>
        }
<span class="nc" id="L125">    }</span>

    private void validateTestCapabilities(com.capitalone.dashboard.request.TestResultRequest request, QTestResult testResult, BooleanBuilder builder) {
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!request.getTypes().isEmpty()) {</span>
<span class="nc" id="L129">            builder.and(testResult.testCapabilities.any().type.in(request.getTypes()));</span>
        }
<span class="nc" id="L131">    }</span>

    private void validateDurationRange(com.capitalone.dashboard.request.TestResultRequest request, QTestResult testResult, BooleanBuilder builder) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (request.validDurationRange()) {</span>
<span class="nc" id="L135">            builder.and(testResult.duration.between(request.getDurationGreaterThan(), request.getDurationLessThan()));</span>
        }
<span class="nc" id="L137">    }</span>

    private void validateEndDateRange(com.capitalone.dashboard.request.TestResultRequest request, QTestResult testResult, BooleanBuilder builder) {
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (request.validEndDateRange()) {</span>
<span class="nc" id="L141">            builder.and(testResult.endTime.between(request.getEndDateBegins(), request.getEndDateEnds()));</span>
        }
<span class="nc" id="L143">    }</span>

    private void validateStartDateRange(com.capitalone.dashboard.request.TestResultRequest request, QTestResult testResult, BooleanBuilder builder) {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (request.validStartDateRange()) {</span>
<span class="nc" id="L147">            builder.and(testResult.startTime.between(request.getStartDateBegins(), request.getStartDateEnds()));</span>
        }
<span class="nc" id="L149">    }</span>

    private Iterable&lt;TestResult&gt; pruneToDepth(List&lt;TestResult&gt; results, Integer depth) {
        // Prune the response to the requested depth
        // 0 - TestResult
        // 1 - TestCapability
        // 2 - TestSuite
        // 3 - TestCase
        // 4 - Entire response
        // null - Entire response
<span class="nc bnc" id="L159" title="All 4 branches missed.">        if (depth == null || depth &gt; 3) {</span>
<span class="nc" id="L160">            return results;</span>
        }
<span class="nc" id="L162">        results.forEach(result -&gt; {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (depth == 0) {</span>
<span class="nc" id="L164">                result.getTestCapabilities().clear();</span>
            } else {
<span class="nc" id="L166">                result.getTestCapabilities().forEach(testCapability -&gt; {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    if (depth == 1) {</span>
<span class="nc" id="L168">                        testCapability.getTestSuites().clear();</span>
                    } else {
<span class="nc" id="L170">                        testCapability.getTestSuites().forEach(testSuite -&gt; {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                            if (depth == 2) {</span>
<span class="nc" id="L172">                                testSuite.getTestCases().clear();</span>
                            } else { // depth == 3
<span class="nc" id="L174">                                testSuite.getTestCases().forEach(testCase -&gt; {</span>
<span class="nc" id="L175">                                    testCase.getTestSteps().clear();</span>
<span class="nc" id="L176">                                });</span>
                            }
<span class="nc" id="L178">                        });</span>
                    }
<span class="nc" id="L180">                });</span>
            }
<span class="nc" id="L182">        });</span>

<span class="nc" id="L184">        return results;</span>
    }


    protected TestResult createTest(TestDataCreateRequest request) throws HygieiaException {
        /*
          Step 1: create Collector if not there
          Step 2: create Collector item if not there
          Step 3: Insert test data if new. If existing, update it
         */
<span class="fc" id="L194">        Collector collector = createCollector();</span>

<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        if (collector == null) {</span>
<span class="nc" id="L197">            throw new HygieiaException(&quot;Failed creating Test collector.&quot;, HygieiaException.COLLECTOR_CREATE_ERROR);</span>
        }

<span class="fc" id="L200">        CollectorItem collectorItem = createCollectorItem(collector, request);</span>

<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (collectorItem == null) {</span>
<span class="nc" id="L203">            throw new HygieiaException(&quot;Failed creating Test collector item.&quot;, HygieiaException.COLLECTOR_ITEM_CREATE_ERROR);</span>
        }

<span class="fc" id="L206">        TestResult testResult = createTest(collectorItem, request);</span>

<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (testResult == null) {</span>
<span class="nc" id="L209">            throw new HygieiaException(&quot;Failed inserting/updating Test information.&quot;, HygieiaException.ERROR_INSERTING_DATA);</span>
        }

<span class="fc" id="L212">        return testResult;</span>

    }

    @Override
    public String create(TestDataCreateRequest request) throws HygieiaException {
<span class="fc" id="L218">        TestResult testResult = createTest(request);</span>
<span class="fc" id="L219">        return testResult.getId().toString();</span>
    }

    @Override
    public String createV2(TestDataCreateRequest request) throws HygieiaException {
<span class="fc" id="L224">        TestResult testResult = createTest(request);</span>
<span class="fc" id="L225">        return testResult.getId().toString() + &quot;,&quot; + testResult.getCollectorItemId().toString();</span>
    }



    protected TestResult createPerfTest(PerfTestDataCreateRequest request) throws HygieiaException {
        /**
         * Step 1: create performance Collector if not there
         * Step 2: create Perfomance Collector item if not there
         * Step 3: Insert performance test data if new. If existing, update it
         */
<span class="nc" id="L236">        Collector collector = createGenericCollector(request.getPerfTool());</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (collector == null) {</span>
<span class="nc" id="L238">            throw new HygieiaException(&quot;Failed creating Test collector.&quot;, HygieiaException.COLLECTOR_CREATE_ERROR);</span>
        }
<span class="nc" id="L240">        CollectorItem collectorItem = createGenericCollectorItem(collector, request);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (collectorItem == null) {</span>
<span class="nc" id="L242">            throw new HygieiaException(&quot;Failed creating Test collector item.&quot;, HygieiaException.COLLECTOR_ITEM_CREATE_ERROR);</span>
        }
<span class="nc" id="L244">        TestResult testResult = createPerfTest(collectorItem, request);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (testResult == null) {</span>
<span class="nc" id="L246">            throw new HygieiaException(&quot;Failed inserting/updating Test information.&quot;, HygieiaException.ERROR_INSERTING_DATA);</span>
        }
<span class="nc" id="L248">        return testResult;</span>

    }

    protected List&lt;TestResult&gt; createTestCucumber(TestCreateRequest request) throws HygieiaException {

<span class="fc" id="L254">        CucumberJsonReport.Feature cucumberFeature = null;</span>

        try {
<span class="fc" id="L257">            cucumberFeature = decodeJsonPayload(CucumberJsonReport.Feature.class , request);</span>
<span class="pc bpc" id="L258" title="4 of 8 branches missed.">            if(cucumberFeature.getId() == null || cucumberFeature.getKeyword() == null || cucumberFeature.getName() == null || cucumberFeature.getElements() == null) {</span>
<span class="nc" id="L259">                throw new HygieiaException(&quot;TestResult is not a valid json.&quot;, HygieiaException.JSON_FORMAT_ERROR);</span>
            }
<span class="nc" id="L261">        }catch (Exception ex){</span>
<span class="nc" id="L262">            throw new HygieiaException(&quot;TestResult is not a valid json.&quot;, HygieiaException.JSON_FORMAT_ERROR);</span>
<span class="fc" id="L263">        }</span>
<span class="fc" id="L264">        Collector collector = createGenericCollector(request, TestResultConstants.JENKINSCUCUMBERTEST);</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">        if (collector == null) {</span>
<span class="nc" id="L266">            throw new HygieiaException(&quot;Failed creating Test collector.&quot;, HygieiaException.COLLECTOR_CREATE_ERROR);</span>
        }
<span class="fc" id="L268">        CollectorItem collectorItem = createGenericCollectorItem(collector, request , cucumberFeature.getName());</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (collectorItem == null) {</span>
<span class="nc" id="L270">            throw new HygieiaException(&quot;Failed creating Test collector item.&quot;, HygieiaException.COLLECTOR_ITEM_CREATE_ERROR);</span>
        }
<span class="fc" id="L272">        List&lt;CucumberJsonReport.Feature&gt; features = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L273">        features.add(cucumberFeature);</span>
<span class="fc" id="L274">        CucumberJsonReport cucumberRequest = new CucumberJsonReport(features);</span>
<span class="fc" id="L275">        CucumberJsonToTestCapabilityTransformer transformer = new CucumberJsonToTestCapabilityTransformer(null,&quot;&quot;);</span>
<span class="fc" id="L276">        TestCapability testCapability = transformer.convert(cucumberRequest);</span>
<span class="fc" id="L277">        TestResult testResult = createTestCucumber(collectorItem,cucumberFeature , TestSuiteType.Functional, request, testCapability);</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">        if (testResult == null) {</span>
<span class="nc" id="L279">            throw new HygieiaException(&quot;Failed inserting cucumber Test information.&quot;, HygieiaException.ERROR_INSERTING_DATA);</span>
        }

<span class="fc" id="L282">        List&lt;TestResult&gt; testResults = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L283">        testResults.add(testResult);</span>
<span class="fc" id="L284">        return testResults;</span>

    }

    protected List&lt;TestResult&gt; processTestJunit(TestCreateRequest request) throws HygieiaException {
<span class="pc bpc" id="L289" title="2 of 4 branches missed.">        if(request == null || StringUtils.isEmpty(request.getTestResult())) {</span>
<span class="nc" id="L290">            throw new HygieiaException(&quot;TestResult is not a valid Xml&quot;, HygieiaException.JSON_FORMAT_ERROR);</span>
        }
<span class="fc" id="L292">        JunitXmlReport junitXmlReport = decodeXmlPayload(JunitXmlReport.class, request);</span>
        JunitXmlReportV2 junitXmlReportV2;
<span class="fc" id="L294">        List&lt;TestResult&gt; testResults = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">        if (junitXmlReport != null) {</span>
<span class="fc" id="L296">            testResults.add(createTestJunit(request, junitXmlReport));</span>
<span class="fc" id="L297">            return testResults;</span>
        } else {
<span class="fc" id="L299">            junitXmlReportV2 = decodeXmlPayload(JunitXmlReportV2.class, request);</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">            if (junitXmlReportV2 == null) {</span>
<span class="nc" id="L301">                throw new HygieiaException(&quot;TestResult is not a valid Xml&quot;, HygieiaException.JSON_FORMAT_ERROR);</span>
            }
        }

<span class="fc" id="L305">        List&lt;JunitXmlReportV2.TestSuite&gt; testSuites = junitXmlReportV2.getTestsuite();</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">        for (JunitXmlReportV2.TestSuite testSuite : testSuites) {</span>
<span class="fc" id="L307">            testResults.add(createTestJunitV2(request, testSuite));</span>
<span class="fc" id="L308">        }</span>
<span class="fc" id="L309">        return testResults;</span>
    }

        protected TestResult createTestJunit(TestCreateRequest request, JunitXmlReport junitXmlReport) throws HygieiaException {
<span class="fc" id="L313">        Collector collector = createGenericCollector(request, TestResultConstants.JUNITTEST);;</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        if (collector == null) {</span>
<span class="nc" id="L315">            throw new HygieiaException(&quot;Failed creating Test collector.&quot;, HygieiaException.COLLECTOR_CREATE_ERROR);</span>
        }
<span class="fc" id="L317">        CollectorItem collectorItem = createGenericCollectorItem(collector, request , junitXmlReport.getName() );</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">        if (collectorItem == null) {</span>
<span class="nc" id="L319">            throw new HygieiaException(&quot;Failed creating Test collector item.&quot;, HygieiaException.COLLECTOR_ITEM_CREATE_ERROR);</span>
        }
<span class="fc" id="L321">        JunitXmlToTestCapabilityTransformer transformer = new JunitXmlToTestCapabilityTransformer();</span>
<span class="fc" id="L322">        TestCapability testCapability = transformer.convert(junitXmlReport);</span>
<span class="fc" id="L323">        TestResult testResult = createTestJunit(collectorItem, junitXmlReport,  TestSuiteType.Unit, request,testCapability);</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">        if (testResult == null) {</span>
<span class="nc" id="L325">            throw new HygieiaException(&quot;Failed inserting Junit Test information.&quot;, HygieiaException.ERROR_INSERTING_DATA);</span>
        }
<span class="fc" id="L327">        return testResult;</span>

    }

    protected TestResult createTestJunitV2(TestCreateRequest request, JunitXmlReportV2.TestSuite junitXmlReportV2Testsuite) throws HygieiaException {
<span class="fc" id="L332">        Collector collector = createGenericCollector(request, TestResultConstants.JUNITTEST);</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">        if (collector == null) {</span>
<span class="nc" id="L334">            throw new HygieiaException(&quot;Failed creating Test collector.&quot;, HygieiaException.COLLECTOR_CREATE_ERROR);</span>
        }
<span class="fc" id="L336">        CollectorItem collectorItem = createGenericCollectorItem(collector, request , junitXmlReportV2Testsuite.getName());</span>
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">        if (collectorItem == null) {</span>
<span class="nc" id="L338">            throw new HygieiaException(&quot;Failed creating Test collector item.&quot;, HygieiaException.COLLECTOR_ITEM_CREATE_ERROR);</span>
        }
<span class="fc" id="L340">        JunitXmlToTestCapabilityTransformerV2 transformer = new JunitXmlToTestCapabilityTransformerV2();</span>
<span class="fc" id="L341">        TestCapability testCapability = transformer.convert(junitXmlReportV2Testsuite);</span>
<span class="fc" id="L342">        TestResult testResult = createTestJunitV2(collectorItem, junitXmlReportV2Testsuite,  TestSuiteType.Unit, request, testCapability);</span>
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">        if (testResult == null) {</span>
<span class="nc" id="L344">            throw new HygieiaException(&quot;Failed inserting Junit Test information.&quot;, HygieiaException.ERROR_INSERTING_DATA);</span>
        }
<span class="fc" id="L346">        return testResult;</span>

    }

    private &lt;T&gt; T decodeJsonPayload (Class&lt;T&gt; type , TestCreateRequest request) throws HygieiaException{
<span class="pc bpc" id="L351" title="2 of 4 branches missed.">        if(request == null || StringUtils.isEmpty(request.getTestResult())) {</span>
<span class="nc" id="L352">            throw new HygieiaException(&quot;TestResult is not a valid json.&quot;, HygieiaException.JSON_FORMAT_ERROR);</span>
        }
<span class="fc" id="L354">        byte[] decodedBytes = Base64.getDecoder().decode(request.getTestResult());</span>
<span class="fc" id="L355">        String decodedPayload = new String(decodedBytes);</span>
<span class="fc" id="L356">        Gson gson = new Gson();</span>
<span class="fc" id="L357">        return gson.fromJson(decodedPayload , type);</span>

    }

    private &lt;T&gt; T decodeXmlPayload (Class&lt;T&gt; type , TestCreateRequest request) {
<span class="fc" id="L362">        byte[] decodedBytes = Base64.getDecoder().decode(request.getTestResult());</span>
<span class="fc" id="L363">        String decodedPayload = new String(decodedBytes);</span>
<span class="fc" id="L364">        StringReader sr = new StringReader(decodedPayload);</span>
<span class="fc" id="L365">        T junitXmlReport = null;</span>
        try {
<span class="fc" id="L367">            JAXBContext jaxbContext = JAXBContext.newInstance(type);</span>
<span class="fc" id="L368">            Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();</span>
<span class="fc" id="L369">            junitXmlReport = (T) unmarshaller.unmarshal(sr);</span>
<span class="fc" id="L370">            LOGGER.info(&quot;Successful transformation to &quot; + type + &quot; xml format type&quot;);</span>
<span class="fc" id="L371">        }catch (JAXBException ex){</span>
<span class="fc" id="L372">            LOGGER.info(&quot;Could not transform to &quot; + type + &quot; xml format type: &quot; + ex.toString());</span>
<span class="fc" id="L373">        }</span>
<span class="fc" id="L374">        return junitXmlReport;</span>
    }

    @Override
    public String createTest(TestCreateRequest request) throws HygieiaException {
<span class="fc" id="L379">        List&lt;TestResult&gt; testResults = null;</span>
<span class="fc" id="L380">        String response = &quot;&quot;;</span>
<span class="fc" id="L381">        validConfigurationItem(request.getConfigurationItem(),request.getTargetAppName());</span>
<span class="pc bpc" id="L382" title="1 of 4 branches missed.">        if (TestResultConstants.FUNCTIONAL.equals(request.getTestType()) &amp;&amp; apiSettings.getFunctional().get(&quot;cucumber&quot;).equals(request.getSourceFormat())) {</span>

<span class="fc" id="L384">            testResults = createTestCucumber(request);</span>

<span class="pc bpc" id="L386" title="2 of 4 branches missed.">        } else if (TestResultConstants.UNIT.equals(request.getTestType())&amp;&amp; apiSettings.getUnit().equals(request.getSourceFormat())) {</span>

<span class="fc" id="L388">            testResults = processTestJunit(request);</span>
        } else {
<span class="nc" id="L390">            return &quot;Hygieia does not support &quot; + request.getTestType() + &quot; sourceFormat &quot; + request.getSourceFormat();</span>
        }
<span class="fc bfc" id="L392" title="All 2 branches covered.">        for (TestResult testResult : testResults) {</span>
<span class="fc" id="L393">            response += testResult.getId() + &quot;, &quot; + testResult.getCollectorItemId() + &quot;;&quot;;</span>
<span class="fc" id="L394">        }</span>
<span class="fc" id="L395">        return response;</span>
    }


    @Override
    public String createPerf(PerfTestDataCreateRequest request) throws HygieiaException {
<span class="nc" id="L401">        TestResult testResult = createPerfTest(request);</span>
<span class="nc" id="L402">        return testResult.getId().toString();</span>
    }

    @Override
    public String createPerfV2(PerfTestDataCreateRequest request) throws HygieiaException {
<span class="nc" id="L407">        TestResult testResult = createPerfTest(request);</span>
<span class="nc" id="L408">        return testResult.getId().toString() + &quot;,&quot; + testResult.getCollectorItemId().toString();</span>
    }

    private Collector createCollector() {
<span class="fc" id="L412">        CollectorRequest collectorReq = new CollectorRequest();</span>
<span class="fc" id="L413">        collectorReq.setName(&quot;JenkinsCucumberTest&quot;);</span>
<span class="fc" id="L414">        collectorReq.setCollectorType(CollectorType.Test);</span>
<span class="fc" id="L415">        Collector col = collectorReq.toCollector();</span>
<span class="fc" id="L416">        col.setEnabled(true);</span>
<span class="fc" id="L417">        col.setOnline(true);</span>
<span class="fc" id="L418">        col.setLastExecuted(System.currentTimeMillis());</span>
<span class="fc" id="L419">        Map&lt;String, Object&gt; allOptions = new HashMap&lt;&gt;();</span>
<span class="fc" id="L420">        allOptions.put(&quot;jobUrl&quot;, &quot;&quot;);</span>
<span class="fc" id="L421">        allOptions.put(&quot;instanceUrl&quot;, &quot;&quot;);</span>
<span class="fc" id="L422">        allOptions.put(&quot;jobName&quot;,&quot;&quot;);</span>
<span class="fc" id="L423">        allOptions.put(&quot;testType&quot;,&quot;&quot;);</span>
<span class="fc" id="L424">        col.setAllFields(allOptions);</span>
        //Combination of jobName and jobUrl should be unique always.
<span class="fc" id="L426">        Map&lt;String, Object&gt; uniqueOptions = new HashMap&lt;&gt;();</span>
<span class="fc" id="L427">        uniqueOptions.put(&quot;jobUrl&quot;, &quot;&quot;);</span>
<span class="fc" id="L428">        uniqueOptions.put(&quot;jobName&quot;,&quot;&quot;);</span>
<span class="fc" id="L429">        uniqueOptions.put(&quot;testType&quot;,&quot;&quot;);</span>
<span class="fc" id="L430">        col.setUniqueFields(uniqueOptions);</span>
<span class="fc" id="L431">        return collectorService.createCollector(col);</span>
    }


    private Collector createGenericCollector(String performanceTool) {
<span class="nc" id="L436">        CollectorRequest collectorReq = new CollectorRequest();</span>
<span class="nc" id="L437">        collectorReq.setName(performanceTool);</span>
<span class="nc" id="L438">        collectorReq.setCollectorType(CollectorType.Test);</span>
<span class="nc" id="L439">        Collector col = collectorReq.toCollector();</span>
<span class="nc" id="L440">        col.setEnabled(true);</span>
<span class="nc" id="L441">        col.setOnline(true);</span>
<span class="nc" id="L442">        col.setLastExecuted(System.currentTimeMillis());</span>
<span class="nc" id="L443">        Map&lt;String, Object&gt; allOptions = new HashMap&lt;&gt;();</span>
<span class="nc" id="L444">        allOptions.put(&quot;jobName&quot;,&quot;&quot;);</span>
<span class="nc" id="L445">        allOptions.put(&quot;instanceUrl&quot;, &quot;&quot;);</span>
<span class="nc" id="L446">        allOptions.put(&quot;testType&quot;,&quot;&quot;);</span>
<span class="nc" id="L447">        col.setAllFields(allOptions);</span>
<span class="nc" id="L448">        col.setUniqueFields(allOptions);</span>
<span class="nc" id="L449">        return collectorService.createCollector(col);</span>
    }

    private CollectorItem createCollectorItem(Collector collector, TestDataCreateRequest request) throws HygieiaException {
<span class="fc" id="L453">        CollectorItem tempCi = new CollectorItem();</span>
<span class="fc" id="L454">        tempCi.setCollectorId(collector.getId());</span>
<span class="fc" id="L455">        tempCi.setDescription(request.getDescription());</span>
<span class="fc" id="L456">        tempCi.setPushed(true);</span>
<span class="fc" id="L457">        tempCi.setLastUpdated(System.currentTimeMillis());</span>
<span class="fc" id="L458">        Map&lt;String, Object&gt; option = new HashMap&lt;&gt;();</span>
<span class="fc" id="L459">        option.put(&quot;jobName&quot;, request.getTestJobName());</span>
<span class="fc" id="L460">        option.put(&quot;jobUrl&quot;, request.getTestJobUrl());</span>
<span class="fc" id="L461">        option.put(&quot;instanceUrl&quot;, request.getServerUrl());</span>
<span class="fc" id="L462">        option.put(&quot;testType&quot;,request.getType());</span>
<span class="fc" id="L463">        tempCi.getOptions().putAll(option);</span>
<span class="fc" id="L464">        tempCi.setNiceName(request.getNiceName());</span>
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">        if (StringUtils.isEmpty(tempCi.getNiceName())) {</span>
<span class="fc" id="L466">            return collectorService.createCollectorItem(tempCi);</span>
        }
<span class="nc" id="L468">        return collectorService.createCollectorItemByNiceNameAndJobName(tempCi, request.getTestJobName());</span>
    }


    private CollectorItem createGenericCollectorItem(Collector collector, PerfTestDataCreateRequest request) {
<span class="nc" id="L473">        CollectorItem tempCi = new CollectorItem();</span>
<span class="nc" id="L474">        tempCi.setCollectorId(collector.getId());</span>
<span class="nc" id="L475">        tempCi.setDescription(request.getPerfTool()+&quot; : &quot;+request.getTestName());</span>
<span class="nc" id="L476">        tempCi.setPushed(true);</span>
<span class="nc" id="L477">        tempCi.setLastUpdated(System.currentTimeMillis());</span>
<span class="nc" id="L478">        Map&lt;String, Object&gt; option = new HashMap&lt;&gt;();</span>
<span class="nc" id="L479">        option.put(&quot;jobName&quot;, request.getTestName());</span>
<span class="nc" id="L480">        option.put(&quot;instanceUrl&quot;, request.getInstanceUrl());</span>
<span class="nc" id="L481">        option.put(&quot;testType&quot;,request.getType());</span>
<span class="nc" id="L482">        tempCi.getOptions().putAll(option);</span>
<span class="nc" id="L483">        tempCi.setNiceName(request.getPerfTool());</span>
<span class="nc" id="L484">        return collectorService.createCollectorItem(tempCi);</span>
    }


    private Collector createGenericCollector(TestCreateRequest request, String name) {
<span class="fc" id="L489">        CollectorRequest collectorReq = new CollectorRequest();</span>
<span class="fc" id="L490">        collectorReq.setName(name);</span>
<span class="fc" id="L491">        collectorReq.setCollectorType(CollectorType.Test);</span>
<span class="fc" id="L492">        Collector col = collectorReq.toCollector();</span>
<span class="fc" id="L493">        col.setEnabled(true);</span>
<span class="fc" id="L494">        col.setOnline(true);</span>
<span class="fc" id="L495">        col.setLastExecuted(System.currentTimeMillis());</span>
<span class="fc" id="L496">        Map&lt;String, Object&gt; allOptions = new HashMap&lt;&gt;();</span>
<span class="fc" id="L497">        allOptions.put(&quot;jobUrl&quot;, &quot;&quot;);</span>
<span class="fc" id="L498">        allOptions.put(&quot;jobName&quot;,&quot;&quot;);</span>
<span class="fc" id="L499">        allOptions.put(&quot;instanceUrl&quot;, &quot;&quot;);</span>
<span class="fc" id="L500">        allOptions.put(&quot;testType&quot;,&quot;&quot;);</span>
<span class="fc" id="L501">        col.setAllFields(allOptions);</span>
<span class="fc" id="L502">        col.setUniqueFields(allOptions);</span>
<span class="fc" id="L503">        return collectorService.createCollector(col);</span>
    }

    private Map&lt;String, String&gt; getJobNameAndInstanceUrl(String jobUrl){
<span class="fc" id="L507">        Map&lt;String ,String&gt; map = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">        if(StringUtils.isNotEmpty(jobUrl)){</span>
<span class="nc" id="L509">            Pattern pattern = Pattern.compile(&quot;(.*?://)([^:^/]*)?(.*)?&quot;);</span>
<span class="nc" id="L510">            Matcher matcher = pattern.matcher(jobUrl);</span>
<span class="nc" id="L511">            matcher.find();</span>
<span class="nc" id="L512">            String protocol = matcher.group(1);</span>
<span class="nc" id="L513">            String domain = matcher.group(2);</span>
<span class="nc" id="L514">            String uri = matcher.group(3);</span>
<span class="nc" id="L515">                map.put(&quot;instanceUrl&quot;, protocol+domain);</span>
<span class="nc" id="L516">                map.put(&quot;jobName&quot;, uri);</span>
        }
<span class="fc" id="L518">        return map;</span>
    }



    private CollectorItem createGenericCollectorItem(Collector collector,  TestCreateRequest request, String desc) {
<span class="fc" id="L524">        CollectorItem tempCi = new CollectorItem();</span>
<span class="fc" id="L525">        tempCi.setCollectorId(collector.getId());</span>
<span class="fc" id="L526">        tempCi.setDescription(desc);</span>
<span class="fc" id="L527">        tempCi.setPushed(true);</span>
<span class="fc" id="L528">        tempCi.setLastUpdated(System.currentTimeMillis());</span>
<span class="fc" id="L529">        Map&lt;String, Object&gt; option = new HashMap&lt;&gt;();</span>
<span class="fc" id="L530">        option.put(&quot;jobUrl&quot;, request.getJobUrl());</span>
<span class="fc" id="L531">        Map&lt;String,String&gt; map = getJobNameAndInstanceUrl(request.getJobUrl());</span>
<span class="fc" id="L532">        option.put(&quot;jobName&quot;,map.get(&quot;jobName&quot;));</span>
<span class="fc" id="L533">        option.put(&quot;instanceUrl&quot;, map.get(&quot;instanceUrl&quot;));</span>
<span class="fc" id="L534">        option.put(&quot;testType&quot;,request.getTestType());</span>
<span class="fc" id="L535">        tempCi.getOptions().putAll(option);</span>
<span class="fc" id="L536">        tempCi.setNiceName(request.getSourceFormat());</span>
<span class="fc" id="L537">        return collectorService.createCollectorItem(tempCi);</span>
    }



    private TestResult createTest(CollectorItem collectorItem, TestDataCreateRequest request) {
<span class="fc" id="L543">        TestResult testResult = testResultRepository.findByCollectorItemIdAndExecutionId(collectorItem.getId(),</span>
<span class="fc" id="L544">                request.getExecutionId());</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">        if (testResult == null) {</span>
<span class="fc" id="L546">            testResult = new TestResult();</span>
        }
<span class="fc" id="L548">        testResult.setTargetAppName(request.getTargetAppName());</span>
<span class="fc" id="L549">        testResult.setTargetEnvName(request.getTargetEnvName());</span>
<span class="fc" id="L550">        testResult.setCollectorItemId(collectorItem.getId());</span>
<span class="fc" id="L551">        testResult.setType(request.getType());</span>
<span class="fc" id="L552">        testResult.setDescription(request.getDescription());</span>
<span class="fc" id="L553">        testResult.setDuration(request.getDuration());</span>
<span class="fc" id="L554">        testResult.setEndTime(request.getEndTime());</span>
<span class="fc" id="L555">        testResult.setExecutionId(request.getExecutionId());</span>
<span class="fc" id="L556">        testResult.setFailureCount(request.getFailureCount());</span>
<span class="fc" id="L557">        testResult.setSkippedCount(request.getSkippedCount());</span>
<span class="fc" id="L558">        testResult.setStartTime(request.getStartTime());</span>
<span class="fc" id="L559">        testResult.setSuccessCount(request.getSuccessCount());</span>
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">        if(request.getTimestamp() == 0) request.setTimestamp(System.currentTimeMillis());</span>
<span class="fc" id="L561">        testResult.setTimestamp(request.getTimestamp());</span>
<span class="fc" id="L562">        testResult.setTotalCount(request.getTotalCount());</span>
<span class="fc" id="L563">        testResult.setUnknownStatusCount(request.getUnknownStatusCount());</span>
<span class="fc" id="L564">        testResult.setUrl(request.getTestJobUrl());</span>
<span class="fc" id="L565">        testResult.getTestCapabilities().addAll(request.getTestCapabilities());</span>
<span class="fc" id="L566">        testResult.setBuildId(new ObjectId(request.getTestJobId()));</span>
<span class="fc" id="L567">        testResult.setBuildArtifact(request.getBuildArtifact());</span>
<span class="fc" id="L568">        return testResultRepository.save(testResult);</span>
    }

    private TestResult createPerfTest(CollectorItem collectorItem, PerfTestDataCreateRequest request) {
<span class="nc" id="L572">        TestResult testResult = testResultRepository.findByCollectorItemIdAndExecutionId(collectorItem.getId(),</span>
<span class="nc" id="L573">                request.getRunId());</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (testResult == null) {</span>
<span class="nc" id="L575">            testResult = new TestResult();</span>
        }
<span class="nc" id="L577">        testResult.setTargetAppName(request.getTargetAppName());</span>
<span class="nc" id="L578">        testResult.setTargetEnvName(request.getTargetEnvName());</span>
<span class="nc" id="L579">        testResult.setCollectorItemId(collectorItem.getId());</span>
<span class="nc" id="L580">        testResult.setType(request.getType());</span>
<span class="nc" id="L581">        testResult.setDescription(request.getDescription());</span>
<span class="nc" id="L582">        testResult.setDuration(request.getDuration());</span>
<span class="nc" id="L583">        testResult.setEndTime(request.getEndTime());</span>
<span class="nc" id="L584">        testResult.setExecutionId(request.getRunId());</span>
<span class="nc" id="L585">        testResult.setFailureCount(request.getFailureCount());</span>
<span class="nc" id="L586">        testResult.setSkippedCount(request.getSkippedCount());</span>
<span class="nc" id="L587">        testResult.setStartTime(request.getStartTime());</span>
<span class="nc" id="L588">        testResult.setSuccessCount(request.getSuccessCount());</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">        if(request.getTimestamp() == 0) request.setTimestamp(System.currentTimeMillis());</span>
<span class="nc" id="L590">        testResult.setTimestamp(request.getTimestamp());</span>
<span class="nc" id="L591">        testResult.setTotalCount(request.getTotalCount());</span>
<span class="nc" id="L592">        testResult.setUnknownStatusCount(request.getUnknownStatusCount());</span>
<span class="nc" id="L593">        testResult.setUrl(request.getReportUrl());</span>
<span class="nc" id="L594">        testResult.getTestCapabilities().addAll(request.getTestCapabilities());</span>
<span class="nc" id="L595">        testResult.setDescription(request.getDescription());</span>
<span class="nc" id="L596">        testResult.setResultStatus(request.getResultStatus());</span>
<span class="nc" id="L597">        testResult.setBuildArtifact(request.getBuildArtifact());</span>
<span class="nc" id="L598">        testResult.setPerfRisk(request.getPerfRisk());</span>
<span class="nc" id="L599">        return testResultRepository.save(testResult);</span>
    }




    private TestResult createTestCucumber(CollectorItem collectorItem, CucumberJsonReport.Feature cucumberReport, TestSuiteType type, TestCreateRequest request, TestCapability cucumberTestCapabilityTransformer) {

<span class="fc" id="L607">        TestResult  testResult = new TestResult();</span>
<span class="fc" id="L608">        Collection&lt;TestCapability&gt; testCapabilities = new ArrayList();</span>
<span class="fc" id="L609">        testCapabilities.add(cucumberTestCapabilityTransformer);</span>
<span class="fc" id="L610">        testResult.setTestCapabilities(testCapabilities);</span>
<span class="fc" id="L611">        testResult.setType(type);</span>
<span class="fc" id="L612">        testResult.setCollectorItemId(collectorItem.getId());</span>
<span class="fc" id="L613">        testResult.setDescription(cucumberReport.getName());</span>
<span class="fc" id="L614">        testResult.setTestCapabilities(testCapabilities);</span>
<span class="fc" id="L615">        testResult.setType(type);</span>
<span class="fc" id="L616">        testResult.setCollectorItemId(collectorItem.getId());</span>
<span class="fc" id="L617">        testResult.setTargetEnvName(getConfigurationItem(request.getConfigurationItem(),request.getTargetAppName()));</span>
<span class="fc" id="L618">        testResult.setTargetAppName(request.getTargetAppName());</span>
<span class="fc" id="L619">        testResult.setDuration(cucumberTestCapabilityTransformer.getDuration());</span>
<span class="fc" id="L620">        testResult.setFailureCount(cucumberTestCapabilityTransformer.getFailedTestSuiteCount());</span>
<span class="fc" id="L621">        testResult.setSuccessCount(cucumberTestCapabilityTransformer.getSuccessTestSuiteCount());</span>
<span class="fc" id="L622">        testResult.setSkippedCount(cucumberTestCapabilityTransformer.getSkippedTestSuiteCount());</span>
<span class="fc" id="L623">        testResult.setTotalCount(cucumberTestCapabilityTransformer.getTotalTestSuiteCount());</span>
<span class="fc" id="L624">        testResult.setUnknownStatusCount(cucumberTestCapabilityTransformer.getUnknownStatusTestSuiteCount());</span>
<span class="fc" id="L625">        testResult.setTimestamp(convertTimestamp(request.getTimeStamp()));</span>
<span class="fc" id="L626">        testResult.getTestCapabilities().addAll(testCapabilities);</span>
        // associate build data
<span class="fc" id="L628">        associateBuildToTestResult(request.getJobUrl(), request.getClientReference(), testResult);</span>
<span class="fc" id="L629">        testResult.setClientReference(request.getClientReference());</span>
<span class="fc" id="L630">        TestResult result = testResultRepository.save(testResult);</span>
<span class="fc" id="L631">        return result;</span>
    }

    private void associateBuildToTestResult(String buildUrl, String clientReference, TestResult testResult) {
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">        if (Objects.isNull(buildUrl)) return;</span>
<span class="nc" id="L636">        Build build = buildRepository.findByBuildUrl(buildUrl);</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (Objects.nonNull(build)) {</span>
<span class="nc" id="L638">            build.setClientReference(clientReference);</span>
<span class="nc" id="L639">            testResult.setBuildId(build.getId());</span>
<span class="nc" id="L640">            buildRepository.save(build);</span>
        } else {
<span class="nc" id="L642">            Build baseBuild = new Build();</span>
<span class="nc" id="L643">            baseBuild.setBuildUrl(buildUrl);</span>
<span class="nc" id="L644">            String trailedBuildUrl = HygieiaUtils.normalizeJobUrl(buildUrl);</span>
<span class="nc" id="L645">            Collector collector = collectorRepository.findByName(apiSettings.getBuildCollectorName());</span>
<span class="nc" id="L646">            CollectorItem buildCollectorItem = collectorItemRepository.findByJobUrl(collector.getId(), trailedBuildUrl);</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">            if(Objects.nonNull(buildCollectorItem)){</span>
<span class="nc" id="L648">                baseBuild.setCollectorItemId(buildCollectorItem.getId());</span>
            }
<span class="nc" id="L650">            baseBuild.setBuildStatus(BuildStatus.InProgress);</span>
<span class="nc" id="L651">            baseBuild.setClientReference(clientReference);</span>
<span class="nc" id="L652">            baseBuild = buildRepository.save(baseBuild);</span>
<span class="nc" id="L653">            testResult.setBuildId(baseBuild.getId());</span>
        }
<span class="nc" id="L655">    }</span>


    private TestResult createTestJunit(CollectorItem collectorItem, JunitXmlReport junitXmlReport, TestSuiteType type, TestCreateRequest request, TestCapability testCapability) {

<span class="fc" id="L660">        TestResult  testResult = new TestResult();</span>
<span class="fc" id="L661">        Collection&lt;TestCapability&gt; testCapabilities = new ArrayList();</span>
<span class="fc" id="L662">        testCapabilities.add(testCapability);</span>
<span class="fc" id="L663">        testResult.setTestCapabilities(testCapabilities);</span>
<span class="fc" id="L664">        testResult.setType(type);</span>
<span class="fc" id="L665">        testResult.setCollectorItemId(collectorItem.getId());</span>
<span class="fc" id="L666">        testResult.setDescription(junitXmlReport.getName());</span>
<span class="fc" id="L667">        testResult.setTargetEnvName(getConfigurationItem(request.getConfigurationItem(),request.getTargetAppName()));</span>
<span class="fc" id="L668">        testResult.setTargetAppName((request.getTargetAppName()));</span>
<span class="fc" id="L669">        testResult.setDuration(junitXmlReport.getTime().longValue());</span>
<span class="fc" id="L670">        testResult.setFailureCount(junitXmlReport.getFailures());</span>
<span class="fc" id="L671">        testResult.setSuccessCount(testCapability.getSuccessTestSuiteCount());</span>
<span class="pc bpc" id="L672" title="3 of 4 branches missed.">        testResult.setSkippedCount(StringUtils.isNotEmpty(junitXmlReport.getSkipped())? Integer.parseInt(junitXmlReport.getSkipped()):StringUtils.isNotEmpty(junitXmlReport.getSkips())? Integer.parseInt(junitXmlReport.getSkips()): 0);</span>
<span class="fc" id="L673">        testResult.setTotalCount(junitXmlReport.getTests());</span>
<span class="fc" id="L674">        testResult.setUnknownStatusCount(testCapability.getUnknownStatusTestSuiteCount());</span>
<span class="fc" id="L675">        testResult.setTimestamp(convertTimestamp(request.getTimeStamp()));</span>
        // associate build data
<span class="fc" id="L677">        associateBuildToTestResult(request.getJobUrl(), request.getClientReference(), testResult);</span>
<span class="fc" id="L678">        testResult.setClientReference(request.getClientReference());</span>
<span class="fc" id="L679">        TestResult result = testResultRepository.save(testResult);</span>
<span class="fc" id="L680">        return result;</span>
    }

    private TestResult createTestJunitV2(CollectorItem collectorItem, JunitXmlReportV2.TestSuite junitXmlReportTestsuite, TestSuiteType type, TestCreateRequest request, TestCapability testCapability) {
<span class="fc" id="L684">        TestResult  testResult = new TestResult();</span>
<span class="fc" id="L685">        Collection&lt;TestCapability&gt; testCapabilities = new ArrayList();</span>
<span class="fc" id="L686">        testCapabilities.add(testCapability);</span>
<span class="fc" id="L687">        testResult.setTestCapabilities(testCapabilities);</span>
<span class="fc" id="L688">        testResult.setType(type);</span>
<span class="fc" id="L689">        testResult.setCollectorItemId(collectorItem.getId());</span>
<span class="fc" id="L690">        testResult.setDescription(junitXmlReportTestsuite.getName());</span>
<span class="fc" id="L691">        testResult.setTargetEnvName(getConfigurationItem(request.getConfigurationItem(),request.getTargetAppName()));</span>
<span class="fc" id="L692">        testResult.setTargetAppName((request.getTargetAppName()));</span>
<span class="fc" id="L693">        testResult.setDuration(junitXmlReportTestsuite.getTime().longValue());</span>
<span class="fc" id="L694">        testResult.setFailureCount(junitXmlReportTestsuite.getFailures());</span>
<span class="fc" id="L695">        testResult.setSuccessCount(testCapability.getSuccessTestSuiteCount());</span>
<span class="pc bpc" id="L696" title="3 of 4 branches missed.">        testResult.setSkippedCount(StringUtils.isNotEmpty(junitXmlReportTestsuite.getSkipped())? Integer.parseInt(junitXmlReportTestsuite.getSkipped()):StringUtils.isNotEmpty(junitXmlReportTestsuite.getSkips())? Integer.parseInt(junitXmlReportTestsuite.getSkips()): 0);</span>
<span class="fc" id="L697">        testResult.setTotalCount(junitXmlReportTestsuite.getTests());</span>
<span class="fc" id="L698">        testResult.setUnknownStatusCount(testCapability.getUnknownStatusTestSuiteCount());</span>
<span class="fc" id="L699">        testResult.setTimestamp(convertTimestamp(request.getTimeStamp()));</span>
<span class="fc" id="L700">        TestResult result = testResultRepository.save(testResult);</span>
<span class="fc" id="L701">        return result;</span>
    }

    private String getConfigurationItem(String configurationItem, String targetAppName){

<span class="pc bpc" id="L706" title="1 of 2 branches missed.">        if (StringUtils.isNotBlank(configurationItem))</span>
        {
<span class="fc" id="L708">            return configurationItem;</span>
        }
<span class="nc bnc" id="L710" title="All 2 branches missed.">        else if (StringUtils.isNotBlank(targetAppName) ){</span>
<span class="nc" id="L711">            List&lt;Cmdb&gt; cmdb = cmdbService.configurationItemsByTypeWithFilter(&quot;&quot;, targetAppName,</span>
<span class="nc" id="L712">                   new PageRequest(0, 1)).getContent();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">           if(cmdb.size() &gt; 0){</span>
<span class="nc" id="L714">               return cmdb.get(0).getConfigurationItem();</span>
           }
        }

<span class="nc" id="L718">        return null;</span>
    }

    private void validConfigurationItem(String configurationItem, String targetAppName) throws HygieiaException{

<span class="pc bpc" id="L723" title="1 of 2 branches missed.">        if (StringUtils.isBlank(configurationItem))</span>
        {
<span class="nc bnc" id="L725" title="All 2 branches missed.">            if (StringUtils.isBlank(targetAppName)){</span>
<span class="nc" id="L726">                throw new HygieiaException(&quot;targetAppName should not be null.&quot;,HygieiaException.BAD_DATA);</span>

            }
        }
<span class="fc" id="L730">    }</span>

    private long convertTimestamp (String timestamp){

<span class="fc" id="L734">        long time = 0;</span>

<span class="pc bpc" id="L736" title="1 of 2 branches missed.">        if(StringUtils.isNotEmpty(timestamp)){</span>
<span class="fc" id="L737">          time = DateTimeFormat.forPattern(&quot;yyyy-MM-dd'T'HH:mm:ss.SSS Z&quot;).parseMillis(timestamp);</span>

        }else{
<span class="nc" id="L740">            time = System.currentTimeMillis();</span>
        }


<span class="fc" id="L744">        return time;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>